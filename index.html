<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Paleta extraída de "FX LOGO VERDE"
                        fisioPrimary: '#1B4D3E', // Verde Oscuro Profundo (Texto y Títulos)
                        fisioAccent: '#4CAF50',  // Verde Hoja Vibrante (Botones y La 'X')
                        fisioLight: '#F1F8E9',   // Verde Muy Pálido (Fondos)
                        fisioHover: '#2E7D32'    // Verde Medio (Al pasar el mouse)
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { background-color: #F1F8E9; /* Fondo Verde Suave */ }
    </style>
</head>
<body class="text-gray-800 font-sans">

    <nav class="bg-fisioPrimary text-white p-3 shadow-lg sticky top-0 z-50 border-b-4 border-fisioAccent">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center cursor-pointer gap-3" onclick="showSection('home')">
                <img src="https://lh3.googleusercontent.com/d/1-Oryehjw29qzgFZo9mIpWB-HpldPkNQx" alt="Logo FisioXpress" class="h-14 bg-white rounded-lg p-1 shadow-sm">
                <h1 class="text-xl font-bold tracking-widest hidden md:block">FISIOXPRESS</h1>
            </div>
            <button onclick="showSection('home')" class="text-sm hover:bg-fisioAccent hover:text-white bg-white bg-opacity-10 px-4 py-2 rounded transition flex items-center gap-2">
                <i class="fa-solid fa-home"></i> <span class="hidden md:inline">Menú Principal</span>
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-12 mt-8">
            <h2 class="text-4xl font-extrabold text-fisioPrimary mb-3">Bienvenido al Ecosistema FisioXpress</h2>
            <p class="text-lg text-gray-600">Tu bienestar en las mejores manos.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-6xl mx-auto">
            
            <div onclick="showSection('app-citas')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioAccent group transform hover:-translate-y-2">
                <div class="text-fisioAccent text-5xl mb-6 text-center group-hover:scale-110 transition"><i class="fa-solid fa-calendar-check"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Reserva de Citas</h3>
                <p class="text-sm text-center text-gray-500">Agenda tu sesión de fisioterapia o masajes.</p>
            </div>

            <div onclick="checkAuth('staff')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioPrimary group transform hover:-translate-y-2">
                <div class="text-fisioPrimary text-5xl mb-6 text-center group-hover:scale-110 transition"><i class="fa-solid fa-cash-register"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Control Interno</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Registro de ventas y caja.</p>
            </div>

            <div onclick="checkAuth('staff_historia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioAccent group transform hover:-translate-y-2">
                <div class="text-fisioAccent text-5xl mb-6 text-center group-hover:scale-110 transition"><i class="fa-solid fa-file-medical-alt"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Historias Clínicas</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Evolución de pacientes.</p>
            </div>

            <div onclick="checkAuth('gerencia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-gray-800 group transform hover:-translate-y-2">
                <div class="text-gray-800 text-5xl mb-6 text-center group-hover:scale-110 transition"><i class="fa-solid fa-chart-pie"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Gerencia</h3>
                <p class="text-sm text-center text-gray-500">Acceso Dueño. Finanzas y reportes.</p>
            </div>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20 pt-6">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioAccent">
            <h2 class="text-3xl font-bold text-fisioPrimary mb-8 text-center flex justify-center items-center gap-3">
                <i class="fa-solid fa-calendar-days text-fisioAccent"></i> Agendar Cita
            </h2>
            <form id="form-cita" onsubmit="enviarCita(event)">
                
                <div class="bg-fisioLight p-4 rounded-lg mb-6 border-l-4 border-fisioAccent">
                    <p class="text-sm text-fisioPrimary font-bold">Datos del Paciente</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cita-nombre" placeholder="Nombres" required class="p-4 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent focus:bg-white outline-none transition">
                    <input type="text" id="cita-apellido" placeholder="Apellidos" required class="p-4 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent focus:bg-white outline-none transition">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="cita-doc-tipo" class="p-4 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent outline-none">
                        <option>DNI</option><option>C.E.</option><option>Pasaporte</option>
                    </select>
                    <input type="text" id="cita-doc-num" placeholder="N° Documento" required class="p-4 border-2 border-gray-100 rounded-lg bg-gray-50 col-span-2 focus:border-fisioAccent focus:bg-white outline-none transition">
                </div>

                <div class="mb-4">
                    <input type="email" id="cita-email" placeholder="Correo Electrónico" required class="p-4 border-2 border-gray-100 rounded-lg w-full bg-gray-50 focus:border-fisioAccent focus:bg-white outline-none transition">
                </div>
                
                <div class="mb-8">
                    <input type="tel" id="cita-whatsapp" placeholder="WhatsApp (Ej: 999888777)" required class="p-4 border-2 border-gray-100 rounded-lg w-full bg-gray-50 focus:border-fisioAccent focus:bg-white outline-none transition">
                </div>

                <div class="bg-fisioLight p-4 rounded-lg mb-6 border-l-4 border-fisioAccent">
                    <p class="text-sm text-fisioPrimary font-bold">Detalles de la Reserva</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Fecha</label>
                        <input type="date" id="cita-fecha" required class="w-full p-4 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent outline-none transition">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Hora</label>
                        <input type="time" id="cita-hora" required class="w-full p-4 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent outline-none transition" min="09:00" max="20:00">
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Servicio</label>
                    <select id="cita-servicio" class="p-4 border-2 border-gray-100 rounded-lg w-full bg-white font-medium focus:border-fisioAccent outline-none transition">
                        <option>Evaluación Fisioterapéutica</option>
                        <option>Masaje Relajante (30 min)</option>
                        <option>Masaje Descontracturante (45 min)</option>
                        <option>Masaje Deportivo</option>
                        <option>Paquete de Tratamiento</option>
                    </select>
                </div>
                
                <button type="submit" id="btn-cita" class="w-full bg-fisioAccent hover:bg-fisioHover text-white font-extrabold py-4 rounded-xl transition shadow-lg transform hover:-translate-y-1 text-lg">
                    CONFIRMAR RESERVA <i class="fa-solid fa-check ml-2"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20 pt-6">
        <div class="flex justify-between items-center mb-6 bg-white p-5 rounded-2xl shadow-md border-l-8 border-fisioPrimary">
            <h2 class="text-2xl font-bold text-fisioPrimary flex items-center gap-3"><i class="fa-solid fa-clipboard-list"></i> Control Interno</h2>
            <div class="bg-fisioLight p-2 px-4 rounded-full text-fisioPrimary border border-fisioAccent flex items-center gap-2">
                <i class="fa-solid fa-user-check"></i> <span id="staff-name-display" class="font-bold">Staff</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex p-1 bg-gray-100 rounded-xl mb-8">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-fisioAccent shadow-md">Nueva Venta</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:text-red-500 transition-all">Anulación</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta"> 
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Terapeuta</label>
                        <select id="venta-terapeuta" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option value="">Seleccionar...</option>
                            <option>Ana Pisfil</option>
                            <option>Isabel Barriga</option>
                            <option>Carmen Rodriguez</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Paciente</label>
                        <input type="text" id="venta-paciente" placeholder="Nombre Completo" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Fecha</label>
                        <input type="date" id="venta-fecha" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                    <div>
                         <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Servicio</label>
                        <select id="venta-servicio" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required onchange="autoPrice(this)">
                            <option value="">Seleccionar...</option>
                            <option data-price="30">Masaje Relajante 30min (S/30)</option>
                            <option data-price="45">Masaje 45min (S/45)</option>
                            <option data-price="80">Paquete 3 Sesiones (S/80)</option>
                            <option data-price="700">Paquete 10 Fisioterapia (S/700)</option>
                            <option value="custom">Otro / Producto</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Pago</label>
                        <select id="venta-pago" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option>YAPE/PLIN</option>
                            <option>EFECTIVO</option>
                            <option>TARJETA</option>
                        </select>
                    </div>
                </div>

                <div class="mb-8 p-6 bg-fisioLight rounded-xl border border-fisioAccent flex items-center justify-between">
                    <label class="text-lg font-bold text-fisioPrimary">TOTAL A COBRAR (S/)</label>
                    <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-40 p-3 border-2 border-fisioAccent rounded-lg text-3xl font-extrabold text-fisioAccent text-right focus:ring-0 outline-none bg-white" required>
                </div>
                
                <div id="div-anulacion-motivo" class="hidden mb-8 bg-red-50 p-6 rounded-xl border-2 border-red-200">
                    <label class="block text-red-700 font-bold mb-3">⚠️ Motivo de la Anulación</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error de digitación..." class="w-full p-4 border-2 border-red-300 rounded-lg bg-white">
                </div>

                <button type="submit" id="btn-venta" class="w-full bg-fisioAccent hover:bg-fisioHover text-white font-extrabold py-4 rounded-xl text-xl shadow-md transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-save"></i> REGISTRAR
                </button>
            </form>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20 pt-6">
        <div class="flex items-center gap-4 mb-6 bg-white p-5 rounded-2xl shadow-md border-b-4 border-fisioAccent">
            <div class="bg-fisioAccent p-3 rounded-xl text-white"><i class="fa-solid fa-heart-pulse text-2xl"></i></div>
            <h2 class="text-2xl font-bold text-fisioPrimary">Historias Clínicas</h2>
        </div>
        
        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
            <div class="flex gap-4">
                <input type="text" id="historia-search" placeholder="Buscar por DNI o Apellido..." class="flex-grow p-4 border-2 border-gray-100 rounded-xl focus:border-fisioAccent outline-none text-lg bg-gray-50">
                <button onclick="buscarHistoria()" class="bg-fisioPrimary hover:bg-fisioHover text-white px-8 py-4 rounded-xl font-bold transition flex items-center gap-2 text-lg shadow-md">
                    <i class="fa-solid fa-search"></i>
                </button>
            </div>
            <div id="resultados-historia" class="mt-6 p-6 bg-fisioLight border border-fisioAccent rounded-xl hidden"></div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-fisioPrimary">
            <h3 class="text-xl font-bold mb-6 text-fisioPrimary flex items-center gap-2"><i class="fa-solid fa-pen-fancy"></i> Evolución / Historia</h3>
            <form onsubmit="guardarHistoria(event)">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <input id="hc-dni" placeholder="DNI" class="p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    <input id="hc-nombre" placeholder="Nombre Completo" class="p-4 border-2 border-gray-100 rounded-lg col-span-2 focus:border-fisioAccent outline-none" required>
                    <input id="hc-edad" placeholder="Edad" class="p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <textarea id="hc-motivo" placeholder="Motivo Consulta / Diagnóstico" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                    <textarea id="hc-antecedentes" placeholder="Antecedentes" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                     <div class="p-6 border-2 border-gray-100 rounded-lg bg-fisioLight">
                        <label class="block font-bold mb-4 text-fisioPrimary">Nivel de Dolor (EVA 1-10)</label>
                        <div class="flex items-center gap-6">
                            <div class="bg-white w-14 h-14 rounded-full border-4 border-fisioAccent flex items-center justify-center shadow-sm">
                                <span class="text-2xl font-extrabold text-fisioAccent" id="eva-display">1</span>
                            </div>
                            <input type="range" min="1" max="10" value="1" class="w-full accent-fisioAccent h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('eva-display').innerText = this.value; document.getElementById('hc-eva').value = this.value">
                            <input type="hidden" id="hc-eva" value="1">
                        </div>
                     </div>
                     <textarea id="hc-tratamiento" placeholder="Tratamiento realizado..." class="p-4 border-2 border-gray-100 rounded-lg h-full focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <button class="bg-fisioPrimary hover:bg-fisioHover text-white font-extrabold px-8 py-4 rounded-xl w-full shadow-lg transition text-lg">
                    GUARDAR HISTORIA
                </button>
            </form>
        </div>
    </div>

    <div id="app-gerencia" class="hidden-section container mx-auto p-4 fade-in pb-20 pt-6">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-md">
            <div>
                <h2 class="text-3xl font-extrabold text-fisioPrimary">Dashboard</h2>
                <p class="text-sm text-gray-500">Resumen Financiero</p>
            </div>
            <button onclick="cargarFinanzas()" class="bg-fisioLight text-fisioAccent border border-fisioAccent px-6 py-3 rounded-xl hover:bg-fisioAccent hover:text-white transition font-bold flex items-center gap-2 shadow-sm">
                <i class="fa-solid fa-sync"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
            <div class="bg-white p-8 rounded-3xl shadow-xl border-t-4 border-green-500">
                <p class="text-green-600 font-bold uppercase mb-2">Ingresos</p>
                <h3 id="kpi-ingresos" class="text-4xl font-extrabold text-fisioPrimary">S/ ...</h3>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-xl border-t-4 border-red-500">
                <p class="text-red-600 font-bold uppercase mb-2">Gastos</p>
                <h3 id="kpi-gastos" class="text-4xl font-extrabold text-fisioPrimary">S/ ...</h3>
            </div>
            <div class="bg-fisioPrimary p-8 rounded-3xl shadow-xl text-white">
                 <p class="text-fisioAccent font-bold uppercase mb-2">Utilidad Neta</p>
                <h3 id="kpi-utilidad" class="text-4xl font-extrabold">S/ ...</h3>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-fisioLight p-5 border-b border-fisioAccent">
                <h3 class="font-bold text-fisioPrimary">Últimas Transacciones</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white text-fisioPrimary uppercase text-xs font-bold border-b">
                        <tr>
                            <th class="p-5">Fecha</th>
                            <th class="p-5">Paciente</th>
                            <th class="p-5">Servicio</th>
                            <th class="p-5">Monto</th>
                            <th class="p-5">Staff</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-resumen-body" class="divide-y divide-gray-100 text-gray-600">
                        <tr><td colspan="5" class="p-8 text-center italic">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-fisioPrimary bg-opacity-90 hidden flex items-center justify-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md relative">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-fisioAccent"><i class="fa-solid fa-times text-xl"></i></button>
            <div class="text-center mb-8">
                <i class="fa-solid fa-lock text-4xl text-fisioAccent mb-4"></i>
                <h3 class="text-2xl font-extrabold text-fisioPrimary">Acceso Restringido</h3>
            </div>
            <input type="password" id="input-pass" class="w-full p-5 border-2 border-gray-200 rounded-xl text-center text-2xl font-bold text-fisioPrimary focus:border-fisioAccent outline-none mb-6" placeholder="••••••">
            <button onclick="verifyPass()" class="w-full py-4 bg-fisioAccent text-white font-extrabold rounded-xl hover:bg-fisioHover transition shadow-lg text-lg">ENTRAR</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwvpmjT4JEZqGLcbL3IwI9CG2YaMOrg-zT0JSVeZWmuVLH7-LyoYyUrUiMLDo-wE29Rdg/exec'; 

        let currentTarget = '';
        let staffUser = 'Anónimo';

        document.addEventListener('DOMContentLoaded', () => {
             const hoy = new Date().toISOString().split('T')[0];
             if(document.getElementById('venta-fecha')) document.getElementById('venta-fecha').value = hoy;
             if(document.getElementById('cita-fecha')) document.getElementById('cita-fecha').value = hoy;
        });

        function showSection(id) {
            document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
        }

        function checkAuth(target) {
            currentTarget = target;
            document.getElementById('modal-auth').classList.remove('hidden');
            document.getElementById('input-pass').value = '';
            document.getElementById('input-pass').focus();
        }

        function closeModal() {
            document.getElementById('modal-auth').classList.add('hidden');
        }

        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            if (currentTarget === 'staff' || currentTarget === 'staff_historia') {
                if (pass === 'Fisio.123') {
                    staffUser = prompt("¿Quién eres?", "") || "Staff";
                    document.getElementById('staff-name-display').innerText = staffUser;
                    closeModal();
                    showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia');
                } else alert('Clave incorrecta');
            } else if (currentTarget === 'gerencia') {
                if (pass === 'marioyavril.') {
                    closeModal();
                    showSection('app-gerencia');
                    cargarFinanzas();
                } else alert('Clave incorrecta');
            }
        }

        function enviarCita(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-cita');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            const data = {
                action: 'nuevaCita',
                nombres: document.getElementById('cita-nombre').value,
                apellidos: document.getElementById('cita-apellido').value,
                dni: document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value,
                email: document.getElementById('cita-email').value,
                whatsapp: document.getElementById('cita-whatsapp').value,
                fecha: document.getElementById('cita-fecha').value,
                hora: document.getElementById('cita-hora').value,
                servicio: document.getElementById('cita-servicio').value
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { alert('¡Cita Confirmada!'); e.target.reset(); showSection('home'); })
            .catch(() => alert('Error de conexión'))
            .finally(() => { btn.innerHTML = originalHtml; btn.disabled = false; });
        }

        function setStaffMode(mode) {
            const estadoInput = document.getElementById('venta-estado');
            const btn = document.getElementById('btn-venta');
            const motivoDiv = document.getElementById('div-anulacion-motivo');
            const tabVenta = document.getElementById('tab-venta');
            const tabAnulacion = document.getElementById('tab-anulacion');
            
            if (mode === 'anulacion') {
                estadoInput.value = 'Anulación';
                btn.classList.replace('bg-fisioAccent', 'bg-red-600');
                btn.innerHTML = 'CONFIRMAR ANULACIÓN';
                motivoDiv.classList.remove('hidden');
                document.getElementById('anulacion-motivo').required = true;
                
                tabVenta.classList.replace('text-fisioAccent', 'text-gray-500');
                tabVenta.classList.remove('shadow-md', 'bg-white');
                tabAnulacion.classList.replace('text-gray-500', 'text-red-600');
                tabAnulacion.classList.add('shadow-md', 'bg-white');
            } else {
                estadoInput.value = 'Venta';
                btn.classList.replace('bg-red-600', 'bg-fisioAccent');
                btn.innerHTML = 'REGISTRAR';
                motivoDiv.classList.add('hidden');
                document.getElementById('anulacion-motivo').required = false;

                tabAnulacion.classList.replace('text-red-600', 'text-gray-500');
                tabAnulacion.classList.remove('shadow-md', 'bg-white');
                tabVenta.classList.replace('text-gray-500', 'text-fisioAccent');
                tabVenta.classList.add('shadow-md', 'bg-white');
            }
        }

        function autoPrice(select) {
            const price = select.options[select.selectedIndex].getAttribute('data-price');
            if(price) document.getElementById('venta-monto').value = price;
        }

        function registrarVenta(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-venta');
            btn.innerHTML = 'Guardando...';
            btn.disabled = true;
            
            const data = {
                action: 'registrarVenta',
                usuarioLogueado: staffUser,
                terapeuta: document.getElementById('venta-terapeuta').value,
                paciente: document.getElementById('venta-paciente').value,
                fechaSesion: document.getElementById('venta-fecha').value,
                servicio: document.getElementById('venta-servicio').value,
                monto: document.getElementById('venta-monto').value,
                medioPago: document.getElementById('venta-pago').value,
                estado: document.getElementById('venta-estado').value,
                origen: document.getElementById('anulacion-motivo').value || 'Venta' 
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { alert('Registrado'); e.target.reset(); document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; setStaffMode('venta'); })
            .finally(() => { btn.innerHTML = 'REGISTRAR'; btn.disabled = false; });
        }

        function cargarFinanzas() {
            const tbody = document.getElementById('tabla-resumen-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">Cargando...</td></tr>';
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'obtenerFinanzas'}) })
            .then(r => r.json())
            .then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`;
                document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`;
                document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                
                tbody.innerHTML = '';
                if(d.listaVentas.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">Sin datos</td></tr>';
                d.listaVentas.forEach(v => {
                    tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="p-5">${new Date(v[1]).toLocaleDateString()}</td><td class="p-5 font-bold">${v[4]}</td><td class="p-5 text-sm">${v[5]}</td><td class="p-5 font-bold ${v[6] < 0 ? 'text-red-600' : 'text-green-600'}">S/ ${v[6]}</td><td class="p-5 text-sm">${v[10]}</td></tr>`;
                });
            });
        }
    </script>
</body>
</html>