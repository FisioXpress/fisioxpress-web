<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fisioGreen: '#4CAF50', // Verde Principal
                        fisioDark: '#2E7D32',  // Verde Oscuro
                        fisioLight: '#E8F5E9'  // Verde Claro Fondo
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body class="text-gray-800 font-sans">

    <nav class="bg-fisioDark text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="showSection('home')">
                <i class="fa-solid fa-spa text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wider">FISIOXPRESS</h1>
            </div>
            <button onclick="showSection('home')" class="text-sm hover:text-gray-200 bg-white bg-opacity-20 px-3 py-1 rounded">
                <i class="fa-solid fa-home"></i> Men√∫ Principal
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-10 mt-5">
            <h2 class="text-3xl font-bold text-fisioDark mb-2">Bienvenido al Ecosistema FisioXpress</h2>
            <p class="text-gray-600">Seleccione el portal al que desea acceder</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
            
            <div onclick="showSection('app-citas')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-2xl transition cursor-pointer border-t-4 border-blue-500 group">
                <div class="text-blue-500 text-5xl mb-4 text-center group-hover:scale-110 transition"><i class="fa-solid fa-calendar-check"></i></div>
                <h3 class="text-xl font-bold text-center mb-2">Reserva de Citas</h3>
                <p class="text-sm text-center text-gray-500">Agenda tu sesi√≥n de fisioterapia o masajes.</p>
            </div>

            <div onclick="checkAuth('staff')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-2xl transition cursor-pointer border-t-4 border-fisioGreen group">
                <div class="text-fisioGreen text-5xl mb-4 text-center group-hover:scale-110 transition"><i class="fa-solid fa-cash-register"></i></div>
                <h3 class="text-xl font-bold text-center mb-2">Control Interno</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Registro de ventas y caja.</p>
            </div>

            <div onclick="checkAuth('staff_historia')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-2xl transition cursor-pointer border-t-4 border-purple-500 group">
                <div class="text-purple-500 text-5xl mb-4 text-center group-hover:scale-110 transition"><i class="fa-solid fa-file-medical"></i></div>
                <h3 class="text-xl font-bold text-center mb-2">Historias Cl√≠nicas</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Evoluci√≥n de pacientes.</p>
            </div>

            <div onclick="checkAuth('gerencia')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-2xl transition cursor-pointer border-t-4 border-gray-800 group">
                <div class="text-gray-800 text-5xl mb-4 text-center group-hover:scale-110 transition"><i class="fa-solid fa-chart-line"></i></div>
                <h3 class="text-xl font-bold text-center mb-2">Gerencia</h3>
                <p class="text-sm text-center text-gray-500">Acceso Due√±o. Finanzas y reportes.</p>
            </div>
        </div>
        
        <div class="mt-12 text-center">
            <img src="https://via.placeholder.com/600x200?text=Banner+FisioXpress" alt="Banner Publicitario" class="mx-auto rounded-lg shadow opacity-50">
            <p class="text-xs text-gray-400 mt-2">Sistema Integral v1.0</p>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20">
        <div class="bg-white rounded-lg shadow-lg p-8 border-t-4 border-blue-600">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">üìÖ Agendar Cita</h2>
            <form id="form-cita" onsubmit="enviarCita(event)">
                
                <p class="text-sm text-gray-500 mb-4 font-bold">Datos del Paciente (Obligatorios)</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cita-nombre" placeholder="Nombres" required class="p-3 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="text" id="cita-apellido" placeholder="Apellidos" required class="p-3 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="cita-doc-tipo" class="p-3 border rounded bg-gray-50">
                        <option>DNI</option><option>C.E.</option><option>Pasaporte</option>
                    </select>
                    <input type="text" id="cita-doc-num" placeholder="N¬∞ Documento" required class="p-3 border rounded bg-gray-50 col-span-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="mb-4">
                    <input type="email" id="cita-email" placeholder="Correo Electr√≥nico" required class="p-3 border rounded w-full bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div class="mb-4">
                    <input type="tel" id="cita-whatsapp" placeholder="WhatsApp (Ej: 999888777)" required class="p-3 border rounded w-full bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <p class="text-sm text-gray-500 mb-4 font-bold mt-6">Detalles de la Reserva</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-xs text-gray-500">Fecha</label>
                        <input type="date" id="cita-fecha" required class="w-full p-3 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Hora</label>
                        <input type="time" id="cita-hora" required class="w-full p-3 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" min="09:00" max="20:00">
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="block text-gray-700 mb-2">Servicio de inter√©s:</label>
                    <select id="cita-servicio" class="p-3 border rounded w-full bg-gray-50 font-medium">
                        <option>Evaluaci√≥n Fisioterap√©utica</option>
                        <option>Masaje Relajante (30 min)</option>
                        <option>Masaje Descontracturante (45 min)</option>
                        <option>Masaje Deportivo</option>
                        <option>Paquete de Tratamiento</option>
                    </select>
                </div>
                
                <button type="submit" id="btn-cita" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition shadow-lg transform hover:-translate-y-1">
                    CONFIRMAR RESERVA
                </button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20">
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded shadow">
            <h2 class="text-2xl font-bold text-fisioDark">Control Interno</h2>
            <div class="text-sm bg-yellow-100 p-2 rounded-lg text-yellow-800 border border-yellow-200">
                üë§ Trabajando: <span id="staff-name-display" class="font-bold text-lg">Staff</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex space-x-2 mb-6 border-b">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 pb-3 font-bold border-b-4 border-fisioGreen text-fisioDark bg-green-50">Nueva Venta</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 pb-3 text-gray-500 hover:text-red-500 hover:bg-red-50 transition">Registrar Anulaci√≥n</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta"> 
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="text-xs text-gray-500">Terapeuta</label>
                        <select id="venta-terapeuta" class="w-full p-2 border rounded" required>
                            <option value="">Seleccionar...</option>
                            <option>Ana Pisfil</option>
                            <option>Isabel Barriga</option>
                            <option>Carmen Rodriguez</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-gray-500">Paciente</label>
                        <input type="text" id="venta-paciente" placeholder="Nombre Completo del Paciente" class="w-full p-2 border rounded" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="text-xs text-gray-500">Fecha Sesi√≥n</label>
                        <input type="date" id="venta-fecha" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                         <label class="text-xs text-gray-500">Servicio / Producto</label>
                        <select id="venta-servicio" class="w-full p-2 border rounded" required onchange="autoPrice(this)">
                            <option value="">Seleccionar...</option>
                            <option data-price="30">Masaje Relajante 30min (S/30)</option>
                            <option data-price="45">Masaje 45min (S/45)</option>
                            <option data-price="80">Paquete 3 Sesiones (S/80)</option>
                            <option data-price="700">Paquete 10 Fisioterapia (S/700)</option>
                            <option value="custom">Otro / Producto</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Medio de Pago</label>
                        <select id="venta-pago" class="w-full p-2 border rounded" required>
                            <option>YAPE/PLIN</option>
                            <option>EFECTIVO</option>
                            <option>TARJETA</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="text-xs text-gray-500">Monto (S/)</label>
                    <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-full p-3 border rounded text-2xl font-bold text-gray-700" required>
                </div>
                
                <div id="div-anulacion-motivo" class="hidden mb-6 bg-red-50 p-4 rounded border border-red-200">
                    <label class="block text-red-700 font-bold mb-2">‚ö†Ô∏è Motivo de la Anulaci√≥n (Obligatorio)</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error de digitaci√≥n, Cliente pidi√≥ reembolso..." class="w-full p-2 border border-red-300 rounded">
                </div>

                <button type="submit" id="btn-venta" class="w-full bg-fisioGreen hover:bg-fisioDark text-white font-bold py-3 rounded text-lg shadow transition">
                    REGISTRAR OPERACI√ìN
                </button>
            </form>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20">
        <h2 class="text-2xl font-bold text-purple-700 mb-4 bg-white p-4 rounded shadow">Gesti√≥n de Historias Cl√≠nicas</h2>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <label class="block text-gray-600 mb-2 font-bold">Buscar Paciente Existente</label>
            <div class="flex gap-2">
                <input type="text" id="historia-search" placeholder="Ingresa DNI o Apellido..." class="flex-grow p-3 border rounded bg-purple-50 focus:ring-2 focus:ring-purple-500 outline-none">
                <button onclick="buscarHistoria()" class="bg-purple-600 hover:bg-purple-800 text-white px-6 py-2 rounded font-bold transition">
                    <i class="fa-solid fa-search"></i> Buscar
                </button>
            </div>
            <div id="resultados-historia" class="mt-4 p-4 bg-gray-50 border rounded hidden">
                </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
            <h3 class="text-lg font-bold mb-4 text-purple-800">üìù Nueva Evoluci√≥n / Historia</h3>
            <form onsubmit="guardarHistoria(event)">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <input id="hc-dni" placeholder="DNI" class="p-2 border rounded" required>
                    <input id="hc-nombre" placeholder="Nombre Completo" class="p-2 border rounded col-span-2" required>
                    <input id="hc-edad" placeholder="Edad" class="p-2 border rounded">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <textarea id="hc-motivo" placeholder="Motivo Consulta / Diagn√≥stico Actual" class="p-2 border rounded h-24"></textarea>
                    <textarea id="hc-antecedentes" placeholder="Antecedentes / Comorbilidades" class="p-2 border rounded h-24"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                     <div class="p-4 border rounded bg-gray-50">
                        <label class="block font-bold mb-2">Nivel de Dolor (EVA 1-10)</label>
                        <div class="flex items-center gap-4">
                            <span class="text-2xl font-bold text-purple-600" id="eva-display">1</span>
                            <input type="range" min="1" max="10" value="1" class="w-full accent-purple-600" oninput="document.getElementById('eva-display').innerText = this.value; document.getElementById('hc-eva').value = this.value">
                            <input type="hidden" id="hc-eva" value="1">
                        </div>
                     </div>
                     <textarea id="hc-tratamiento" placeholder="Tratamiento realizado hoy (Agentes, Terapia Manual, Ejercicios...)" class="p-2 border rounded h-24"></textarea>
                </div>
                <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-3 rounded w-full shadow transition">
                    GUARDAR EN HISTORIA
                </button>
            </form>
        </div>
    </div>

    <div id="app-gerencia" class="hidden-section container mx-auto p-4 fade-in pb-20">
        <div class="flex justify-between items-center mb-6 bg-white p-6 rounded shadow">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Dashboard Gerencial</h2>
                <p class="text-sm text-gray-500">Vista general de FisioXpress</p>
            </div>
            <button onclick="cargarFinanzas()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 transition">
                <i class="fa-solid fa-sync"></i> Actualizar
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow border-b-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">Ingresos Totales</p>
                        <h3 id="kpi-ingresos" class="text-4xl font-bold text-gray-800 mt-2">S/ ...</h3>
                    </div>
                    <div class="text-green-500 text-3xl"><i class="fa-solid fa-arrow-trend-up"></i></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-b-4 border-red-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">Gastos Operativos</p>
                        <h3 id="kpi-gastos" class="text-4xl font-bold text-gray-800 mt-2">S/ ...</h3>
                    </div>
                    <div class="text-red-500 text-3xl"><i class="fa-solid fa-money-bill-wave"></i></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-b-4 border-blue-800 bg-gray-800 text-white">
                 <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm font-bold uppercase">Utilidad Neta</p>
                        <h3 id="kpi-utilidad" class="text-4xl font-bold mt-2">S/ ...</h3>
                    </div>
                    <div class="text-white text-3xl"><i class="fa-solid fa-wallet"></i></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-700">√öltimas Transacciones</h3>
                <span class="text-xs text-gray-500">Mostrando las 5 m√°s recientes</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-3">Fecha</th>
                            <th class="p-3">Paciente</th>
                            <th class="p-3">Servicio</th>
                            <th class="p-3">Monto</th>
                            <th class="p-3">Registrado Por</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-resumen-body">
                        <tr><td colspan="5" class="p-4 text-center text-gray-500">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="bg-gray-100 p-3 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-lock text-2xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Acceso Restringido</h3>
                <p class="text-sm text-gray-500">Esta zona es solo para personal autorizado</p>
            </div>
            
            <input type="password" id="input-pass" class="w-full p-3 border rounded-lg mb-4 text-center tracking-widest text-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="flex-1 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition">Cancelar</button>
                <button onclick="verifyPass()" class="flex-1 px-4 py-3 bg-fisioGreen text-white font-bold rounded-lg hover:bg-fisioDark transition">Entrar</button>
            </div>
        </div>
    </div>

    <script>
        // --- TU URL DE GOOGLE APPS SCRIPT (YA INTEGRADA) ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwvpmjT4JEZqGLcbL3IwI9CG2YaMOrg-zT0JSVeZWmuVLH7-LyoYyUrUiMLDo-wE29Rdg/exec'; 

        let currentTarget = '';
        let staffUser = 'An√≥nimo';

        // Inicializar fecha
        document.addEventListener('DOMContentLoaded', () => {
             const hoy = new Date().toISOString().split('T')[0];
             if(document.getElementById('venta-fecha')) document.getElementById('venta-fecha').value = hoy;
             if(document.getElementById('cita-fecha')) document.getElementById('cita-fecha').value = hoy;
        });

        function showSection(id) {
            document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
        }

        // --- SISTEMA DE CLAVES ---
        function checkAuth(target) {
            currentTarget = target;
            document.getElementById('modal-auth').classList.remove('hidden');
            document.getElementById('input-pass').value = '';
            document.getElementById('input-pass').focus();
        }

        function closeModal() {
            document.getElementById('modal-auth').classList.add('hidden');
        }

        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            
            // CLAVE STAFF
            if (currentTarget === 'staff' || currentTarget === 'staff_historia') {
                if (pass === 'Fisio.123') {
                    staffUser = prompt("üëã ¬°Hola! Para continuar, ingresa tu nombre:", "");
                    if(!staffUser) staffUser = "Staff Gen√©rico";
                    
                    document.getElementById('staff-name-display').innerText = staffUser;
                    closeModal();
                    showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia');
                } else {
                    alert('‚õî Clave incorrecta');
                }
            } 
            // CLAVE GERENCIA
            else if (currentTarget === 'gerencia') {
                if (pass === 'marioyavril.') {
                    closeModal();
                    showSection('app-gerencia');
                    cargarFinanzas();
                } else {
                    alert('‚õî Clave incorrecta');
                }
            }
        }

        // --- M√ìDULO 1: CITAS ---
        function enviarCita(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-cita');
            const originalText = btn.innerText;
            
            btn.innerText = '‚è≥ Procesando reserva...';
            btn.disabled = true;
            btn.classList.add('opacity-50');

            const data = {
                action: 'nuevaCita',
                nombres: document.getElementById('cita-nombre').value,
                apellidos: document.getElementById('cita-apellido').value,
                dni: document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value,
                email: document.getElementById('cita-email').value,
                whatsapp: document.getElementById('cita-whatsapp').value,
                fecha: document.getElementById('cita-fecha').value,
                hora: document.getElementById('cita-hora').value,
                servicio: document.getElementById('cita-servicio').value
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Importante para enviar a Google Apps Script sin error CORS
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(() => {
                // Como usamos no-cors, asumimos √©xito si no hay error de red
                alert('‚úÖ ¬°Cita Confirmada!\n\nSe ha enviado al calendario y registrado en el sistema.');
                e.target.reset();
                showSection('home');
            })
            .catch(err => {
                alert('‚ùå Hubo un error de conexi√≥n. Int√©ntalo de nuevo.');
                console.error(err);
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            });
        }

        // --- M√ìDULO 2: VENTAS STAFF ---
        function setStaffMode(mode) {
            const estadoInput = document.getElementById('venta-estado');
            const btn = document.getElementById('btn-venta');
            const motivoDiv = document.getElementById('div-anulacion-motivo');
            const tabVenta = document.getElementById('tab-venta');
            const tabAnulacion = document.getElementById('tab-anulacion');
            
            if (mode === 'anulacion') {
                estadoInput.value = 'Anulaci√≥n';
                btn.classList.replace('bg-fisioGreen', 'bg-red-600');
                btn.innerText = 'CONFIRMAR ANULACI√ìN';
                motivoDiv.classList.remove('hidden');
                document.getElementById('anulacion-motivo').required = true;
                
                // Estilos tabs
                tabVenta.classList.remove('border-b-4', 'border-fisioGreen', 'font-bold', 'text-fisioDark');
                tabVenta.classList.add('text-gray-500');
                tabAnulacion.classList.add('border-b-4', 'border-red-500', 'font-bold', 'text-red-600');
            } else {
                estadoInput.value = 'Venta';
                btn.classList.replace('bg-red-600', 'bg-fisioGreen');
                btn.innerText = 'REGISTRAR OPERACI√ìN';
                motivoDiv.classList.add('hidden');
                document.getElementById('anulacion-motivo').required = false;

                // Estilos tabs
                tabAnulacion.classList.remove('border-b-4', 'border-red-500', 'font-bold', 'text-red-600');
                tabVenta.classList.add('border-b-4', 'border-fisioGreen', 'font-bold', 'text-fisioDark');
                tabVenta.classList.remove('text-gray-500');
            }
        }

        function autoPrice(select) {
            const option = select.options[select.selectedIndex];
            const price = option.getAttribute('data-price');
            if(price) document.getElementById('venta-monto').value = price;
        }

        function registrarVenta(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-venta');
            btn.innerText = 'Guardando...';
            btn.disabled = true;
            
            const data = {
                action: 'registrarVenta',
                usuarioLogueado: staffUser, // Se captura al inicio
                terapeuta: document.getElementById('venta-terapeuta').value,
                paciente: document.getElementById('venta-paciente').value,
                fechaSesion: document.getElementById('venta-fecha').value,
                servicio: document.getElementById('venta-servicio').value,
                monto: document.getElementById('venta-monto').value,
                medioPago: document.getElementById('venta-pago').value,
                estado: document.getElementById('venta-estado').value,
                origen: document.getElementById('anulacion-motivo').value || 'Venta Mostrador' 
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(() => {
                alert('‚úÖ Operaci√≥n Registrada Exitosamente');
                e.target.reset();
                document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0];
                setStaffMode('venta');
            })
            .finally(() => {
                btn.innerText = 'REGISTRAR OPERACI√ìN';
                btn.disabled = false;
            });
        }

        // --- M√ìDULO 4: GERENCIA ---
        function cargarFinanzas() {
            // Aqu√≠ usamos redirect para obtener datos (GET no sirve con no-cors, pero Apps Script retorna JSON puro si se usa bien)
            // Truco: Usamos la API normalmente. Si hay CORS, Apps Script necesita una funci√≥n especial. 
            // Para simplificar en este entorno sin servidor, usaremos una petici√≥n opaca.
            
            // NOTA: Para LEER datos (GET) desde una web externa sin servidor intermedio, Google Apps Script es estricto con CORS.
            // Para que funcione al 100% en Netlify, usaremos el m√©todo POST que s√≠ permite intercambio si el script retorna JSONP o JSON correcto.
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({action: 'obtenerFinanzas'})
            })
            .then(r => r.json())
            .then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`;
                document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`;
                document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                
                const tbody = document.getElementById('tabla-resumen-body');
                tbody.innerHTML = '';
                
                if(d.listaVentas.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No hay ventas recientes</td></tr>';
                }

                d.listaVentas.forEach(v => {
                    // v es un array: [fecha, fechaSesion, hora, terapeuta, paciente, servicio, monto, pago, origen, estado, user]
                    // Ajustamos √≠ndices seg√∫n lo que devuelve el script (Verifica tu script backend)
                    let fecha = new Date(v[1]).toLocaleDateString();
                    let paciente = v[4];
                    let servicio = v[5];
                    let monto = v[6];
                    let user = v[10];

                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">${fecha}</td>
                            <td class="p-3 font-bold">${paciente}</td>
                            <td class="p-3 text-xs text-gray-500">${servicio}</td>
                            <td class="p-3 font-bold text-green-600">S/ ${monto}</td>
                            <td class="p-3 text-xs">${user}</td>
                        </tr>`;
                });
            })
            .catch(e => {
                console.log(e);
                document.getElementById('tabla-resumen-body').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Error cargando datos. Revisa la consola.</td></tr>';
            });
        }
    </script>
</body>
</html>