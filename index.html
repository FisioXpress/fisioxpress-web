<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { 'sans': ['Montserrat', 'sans-serif'] },
                extend: {
                    colors: {
                        fisioPrimary: '#2A7C78',       // Verde Corporativo
                        fisioPrimaryHover: '#4CA6A1',  // Verde Claro (Hover)
                        fisioAccent: '#F2911B',        // Naranja Acento
                        fisioText: '#333333',          // Texto Principal
                        fisioSub: '#666666',           // Texto Secundario
                        fisioBg: '#F4F8F8'             // Fondo Suave
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        body { background-color: #F4F8F8; color: #333333; }
        
        /* Botones de acci√≥n principal */
        .btn-action { 
            background-color: #F2911B; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 6px rgba(242, 145, 27, 0.2); 
        }
        .btn-action:hover { 
            background-color: #D98218; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 12px rgba(242, 145, 27, 0.3); 
        }
        
        /* Casillas de Horarios */
        .time-slot { 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            padding: 10px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: white; 
        }
        .time-slot:hover { 
            border-color: #2A7C78; 
            color: #2A7C78; 
        }
        .time-slot.selected { 
            background-color: #2A7C78; 
            color: white; 
            border-color: #2A7C78; 
            font-weight: bold; 
        }
        
        select:disabled { 
            background-color: #e2e8f0; 
            cursor: not-allowed; 
            color: #555; 
        }
    </style>
</head>
<body class="antialiased">

    <nav class="bg-fisioPrimary text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('home')">
                <div class="relative group">
                    <img src="https://lh3.googleusercontent.com/d/1-Oryehjw29qzgFZo9mIpWB-HpldPkNQx" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063176.png'" alt="Logo FisioXpress" class="h-12 w-12 rounded-full border-2 border-white bg-white object-cover shadow-sm group-hover:scale-105 transition">
                </div>
                <span class="text-xl font-extrabold tracking-wide hidden md:block">FISIO<span class="text-fisioAccent">XPRESS</span></span>
            </div>
            
            <button onclick="showSection('home')" class="text-sm bg-white bg-opacity-10 hover:bg-white hover:text-fisioPrimary border border-white/30 text-white px-5 py-2 rounded-full transition font-bold flex items-center gap-2">
                <i class="fa-solid fa-home"></i> <span class="hidden md:inline">Inicio</span>
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-12 mt-8">
            <h2 class="text-4xl font-extrabold text-fisioPrimary mb-3">Bienvenido a FisioXpress</h2>
            <div class="h-1 w-20 bg-fisioAccent mx-auto rounded-full mb-4"></div>
            <p class="text-lg text-fisioSub max-w-2xl mx-auto">Especialistas en recuperaci√≥n r√°pida y bienestar integral.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
            
            <div onclick="showSection('app-citas')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioAccent group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioAccent transition duration-300">
                    <i class="fa-solid fa-calendar-check text-3xl text-fisioAccent group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Reserva de Citas</h3>
                <p class="text-sm text-center text-fisioSub">Agenda tu sesi√≥n.</p>
            </div>
            
            <div onclick="checkAuth('staff')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioPrimary group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioPrimary transition duration-300">
                    <i class="fa-solid fa-cash-register text-3xl text-fisioPrimary group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Control Interno</h3>
                <p class="text-sm text-center text-fisioSub">Acceso Staff.</p>
            </div>
            
            <div onclick="checkAuth('staff_historia')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioAccent group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioAccent transition duration-300">
                    <i class="fa-solid fa-file-medical-alt text-3xl text-fisioAccent group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Historias Cl√≠nicas</h3>
                <p class="text-sm text-center text-fisioSub">Evoluci√≥n.</p>
            </div>
            
            <div onclick="checkAuth('gerencia')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioText group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioText transition duration-300">
                    <i class="fa-solid fa-chart-pie text-3xl text-fisioText group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Gerencia</h3>
                <p class="text-sm text-center text-fisioSub">Reportes.</p>
            </div>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-3 bg-fisioPrimary"></div>
            <h2 class="text-3xl font-extrabold text-fisioPrimary mb-2 text-center">Agendar Cita</h2>
            <p class="text-center text-fisioSub mb-8 text-sm">Reserva tu momento de bienestar.</p>

            <form id="form-cita" onsubmit="enviarCita(event)">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Datos Personales</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="cita-nombre" placeholder="Nombres" required class="p-4 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                        <input type="text" id="cita-apellido" placeholder="Apellidos" required class="p-4 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="cita-doc-tipo" class="p-4 bg-fisioBg rounded-lg outline-none text-fisioText font-medium">
                           <option>DNI</option><option>C.E.</option><option>PASAPORTE</option>
                        </select>
                        <input type="text" id="cita-doc-num" placeholder="Documento" required class="p-4 col-span-2 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                    
                    <div class="mb-4">
                         <input type="tel" id="cita-whatsapp" placeholder="WhatsApp" required class="w-full p-4 bg-fisioBg rounded-lg outline-none focus:ring-2 focus:ring-fisioPrimary mb-4 text-fisioText">
                    </div>
                    <div class="mb-4">
                        <input type="email" id="cita-email" placeholder="Correo Electr√≥nico" required class="w-full p-4 bg-fisioBg rounded-lg outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Detalles del Servicio</label>
                    <select id="cita-servicio" onchange="configurarDuracion()" required class="w-full p-4 bg-fisioBg rounded-lg border-2 border-transparent focus:border-fisioPrimary outline-none font-bold text-fisioPrimary mb-4">
                        <option value="" disabled selected>-- Selecciona un Servicio --</option>
                        <optgroup label="Masajes Terap√©uticos">
                            <option value="Masaje Relajante" data-tipo="variable">Masaje Relajante</option>
                            <option value="Masaje Descontracturante" data-tipo="variable">Masaje Descontracturante</option>
                            <option value="Masaje Xpress" data-tipo="variable">Masaje Xpress (Zonas Dolorosas)</option>
                        </optgroup>
                        <optgroup label="Especializados">
                            <option value="Masaje Deportivo" data-tipo="fijo">Masaje Deportivo</option>
                            <option value="Drenaje Linf√°tico" data-tipo="fijo">Drenaje Linf√°tico</option>
                            <option value="Fisioterapia Especializada" data-tipo="fijo">Fisioterapia Especializada</option>
                        </optgroup>
                    </select>

                    <div id="div-duracion" class="mb-4 hidden fade-in">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 ml-1">Duraci√≥n</label>
                        <select id="cita-duracion" onchange="cargarHorarios()" required class="w-full p-4 bg-white border-2 border-fisioPrimary rounded-lg outline-none font-bold text-fisioText"></select>
                    </div>

                    <div id="div-fecha-hora" class="hidden fade-in">
                        <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Fecha y Hora</label>
                        <input type="date" id="cita-fecha" onchange="cargarHorarios()" required class="p-4 bg-fisioBg rounded-lg w-full mb-4 outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                        <div id="loading-slots" class="hidden text-center text-fisioAccent font-bold py-4"><i class="fa-solid fa-spinner fa-spin"></i> Buscando horarios disponibles...</div>
                        <div id="slots-container" class="grid grid-cols-3 md:grid-cols-4 gap-3"></div>
                        <input type="hidden" id="cita-hora-seleccionada" required>
                    </div>
                </div>

                <button type="submit" id="btn-cita" class="btn-action w-full text-white font-extrabold py-4 rounded-lg text-lg flex items-center justify-center gap-2">CONFIRMAR RESERVA <i class="fa-solid fa-arrow-right"></i></button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioPrimary">
            <h2 class="text-2xl font-bold text-fisioPrimary mb-6 flex items-center gap-2"><i class="fa-solid fa-cash-register"></i> Control Interno</h2>
            <div class="mb-4 text-sm text-fisioSub bg-fisioBg inline-block px-3 py-1 rounded-full border border-gray-200">Usuario: <span id="staff-name-display" class="font-bold text-fisioPrimary">Staff</span></div>
            
            <div class="flex p-1 bg-gray-100 rounded-lg mb-6">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 py-3 rounded-md font-bold bg-white text-fisioPrimary shadow-sm transition">Venta</button>
                <button onclick="setStaffMode('historial')" id="tab-historial" class="flex-1 py-3 rounded-md font-bold text-fisioSub hover:text-fisioPrimary transition">Historial</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 py-3 rounded-md font-bold text-fisioSub hover:text-red-500 transition">Anulaci√≥n</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="venta-terapeuta" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required>
                        <option value="">Terapeuta...</option><option>Ana Pisfil</option><option>Isabel Barriga</option><option>Carmen Rodriguez</option>
                    </select>
                    <div class="col-span-2 flex gap-2">
                        <input type="text" id="venta-dni" placeholder="DNI Paciente" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText">
                        <button type="button" onclick="buscarPacienteVenta()" class="bg-fisioPrimary text-white px-4 rounded-lg font-bold"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
                
                <div class="mb-4">
                     <input type="text" id="venta-paciente" placeholder="Nombre del Paciente" class="p-3 bg-white border-2 border-fisioBg rounded-lg w-full outline-none text-fisioText font-bold" required>
                     <input type="hidden" id="venta-email"><input type="hidden" id="venta-celular">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="date" id="venta-fecha" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required>
                    <select id="venta-servicio" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required onchange="autoPrice(this)">
                        <option value="">Servicio...</option><option data-price="30">Masaje 30min (S/30)</option><option data-price="45">Masaje 45min (S/45)</option><option data-price="80">Paquete 3 Ses (S/80)</option><option data-price="700">Paquete 10 Fisio (S/700)</option><option value="custom">Otro</option>
                    </select>
                    <select id="venta-pago" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required><option>YAPE/PLIN</option><option>EFECTIVO</option><option>TARJETA</option></select>
                </div>
                
                <div class="mb-6 flex justify-between items-center bg-fisioBg p-4 rounded-lg border border-gray-200">
                    <span class="font-bold text-fisioPrimary">MONTO TOTAL (S/)</span>
                    <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-32 p-2 text-right font-bold text-2xl text-fisioPrimary bg-white rounded border border-gray-200 outline-none" required>
                </div>
                
                <div id="div-anulacion-motivo" class="hidden mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                    <label class="text-red-700 font-bold block mb-2">Motivo de Anulaci√≥n:</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error digitaci√≥n" class="w-full p-3 border border-red-300 rounded-lg bg-white">
                </div>
                
                <button type="submit" id="btn-venta" class="btn-action w-full text-white font-bold py-4 rounded-lg shadow-md text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-save"></i> REGISTRAR</button>
            </form>

            <div id="staff-historial-view" class="hidden mt-4">
                <div class="flex gap-2 mb-4">
                   <input id="hist-dni-staff" placeholder="Buscar historial por DNI..." class="w-full p-3 border rounded">
                   <button onclick="buscarHistorial('hist-dni-staff', 'tabla-historial-staff')" class="bg-fisioPrimary text-white px-4 rounded font-bold">VER</button>
                </div>
                <div id="tabla-historial-staff" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioAccent">
            <h2 class="text-2xl font-bold text-fisioPrimary mb-6">Historias Cl√≠nicas</h2>
            
            <div class="bg-fisioBg p-6 rounded-xl mb-6 flex gap-4 items-center border border-gray-100">
                <input type="text" id="historia-search" placeholder="Buscar por DNI o Apellido" class="flex-grow p-4 bg-white rounded-lg border border-transparent focus:border-fisioAccent outline-none shadow-sm text-fisioText">
                <button onclick="buscarHistoria()" class="bg-fisioPrimary hover:bg-fisioPrimaryHover text-white px-6 py-4 rounded-lg font-bold transition shadow-md">Buscar</button>
            </div>
            
            <div id="resultados-historia" class="hidden mb-6 p-4 border rounded bg-gray-50 text-fisioText"></div>
            
            <div class="border-t border-gray-200 pt-6">
                <h3 class="font-bold mb-4 text-fisioPrimary text-lg"><i class="fa-solid fa-file-pen"></i> Nueva Evoluci√≥n</h3>
                
                <form onsubmit="guardarHistoria(event)">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input id="hc-dni" placeholder="DNI" class="p-3 bg-fisioBg rounded-lg outline-none text-fisioText" required>
                        <input id="hc-nombre" placeholder="Nombre Completo" class="p-3 bg-fisioBg rounded-lg col-span-2 outline-none text-fisioText" required>
                        <input id="hc-edad" placeholder="Edad" class="p-3 bg-fisioBg rounded-lg outline-none text-fisioText">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <textarea id="hc-motivo" placeholder="Motivo/Diagn√≥stico" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                        <textarea id="hc-antecedentes" placeholder="Antecedentes" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="p-4 border rounded-lg bg-white shadow-sm flex items-center gap-4">
                            <div class="bg-fisioAccent text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl" id="eva-display">1</div>
                            <div class="flex-grow">
                                <label class="block font-bold text-fisioPrimary text-sm mb-1">Escala de Dolor (EVA)</label>
                                <input type="range" min="1" max="10" value="1" class="w-full accent-fisioAccent cursor-pointer" oninput="document.getElementById('eva-display').innerText=this.value;document.getElementById('hc-eva').value=this.value">
                                <input type="hidden" id="hc-eva" value="1">
                            </div>
                        </div>
                        <textarea id="hc-tratamiento" placeholder="Tratamiento realizado hoy" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                    </div>
                    <button class="w-full bg-fisioPrimary hover:bg-fisioPrimaryHover text-white font-bold py-4 rounded-lg shadow-md transition">GUARDAR EVOLUCI√ìN</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-gerencia" class="hidden-section container mx-auto p-4 fade-in pb-20 pt-10">
        <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-2xl font-bold text-fisioPrimary">Dashboard</h2>
            <button onclick="cargarFinanzas()" class="text-fisioAccent font-bold border border-fisioAccent px-6 py-2 rounded-full hover:bg-fisioAccent hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-sync"></i> Actualizar</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
                <p class="text-xs font-bold text-fisioSub uppercase tracking-widest">Ingresos</p>
                <h3 id="kpi-ingresos" class="text-4xl font-extrabold text-fisioPrimary mt-2">S/ ...</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                <p class="text-xs font-bold text-fisioSub uppercase tracking-widest">Gastos</p>
                <h3 id="kpi-gastos" class="text-4xl font-extrabold text-fisioPrimary mt-2">S/ ...</h3>
            </div>
            <div class="bg-fisioPrimary p-6 rounded-2xl shadow-lg text-white border-b-4 border-fisioAccent">
                <p class="text-xs font-bold text-white opacity-80 uppercase tracking-widest">Utilidad</p>
                <h3 id="kpi-utilidad" class="text-4xl font-extrabold mt-2 text-white">S/ ...</h3>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-fisioBg p-4 font-bold text-fisioPrimary border-b border-gray-200">√öltimas Transacciones</div>
            <table class="w-full text-left">
                <thead class="bg-white text-fisioSub text-xs uppercase border-b border-gray-100"><tr><th class="p-4">Fecha</th><th class="p-4">Paciente</th><th class="p-4 text-right">Monto</th></tr></thead>
                <tbody id="tabla-resumen-body" class="text-sm text-fisioText"><tr><td colspan="3" class="p-8 text-center text-fisioSub">Cargando datos...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-fisioPrimary bg-opacity-95 hidden flex items-center justify-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center transform scale-100 transition-all">
            <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-fisioPrimary"><i class="fa-solid fa-lock"></i></div>
            <h3 class="font-bold text-xl mb-4 text-fisioPrimary">Acceso Restringido</h3>
            <input type="password" id="input-pass" class="w-full p-4 bg-fisioBg rounded-lg mb-4 text-center text-lg outline-none focus:ring-2 focus:ring-fisioAccent text-fisioText" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button onclick="verifyPass()" class="btn-action w-full text-white font-bold py-3 rounded-lg shadow-md transition mb-3">ENTRAR</button>
            <button onclick="closeModal()" class="text-sm text-gray-400 hover:text-gray-600 underline">Cancelar</button>
        </div>
    </div>

    <script>
        // --- TU NUEVA URL DEL GOOGLE SCRIPT ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbw33oK-7zZ594xhiiGwRVG3-4yf7eKytXlF1jWs0l0dxdSv-s89KBznGupkyABONtpTRA/exec';

        let currentTarget = '';
        let staffUser = 'Staff';

        // --- SISTEMA DE NAVEGACI√ìN ---
        function showSection(id) { 
            document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none'); 
            document.getElementById(id).style.display = 'block'; 
            window.scrollTo(0,0); 
        }

        // --- SISTEMA DE AUTENTICACI√ìN ---
        function checkAuth(target) {
            currentTarget = target;
            document.getElementById('modal-auth').classList.remove('hidden');
            document.getElementById('input-pass').value = '';
            document.getElementById('input-pass').focus();
        }
        function closeModal() { document.getElementById('modal-auth').classList.add('hidden'); }
        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            if ((currentTarget === 'staff' || currentTarget === 'staff_historia') && pass === 'Fisio.123') {
                staffUser = prompt("¬øQui√©n eres?", "Staff") || "Staff";
                document.getElementById('staff-name-display').innerText = staffUser;
                closeModal(); showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia');
            } else if (currentTarget === 'gerencia' && pass === 'marioyavril.') {
                closeModal(); showSection('app-gerencia'); cargarFinanzas();
            } else { alert('‚õî Clave incorrecta'); }
        }

        // --- L√ìGICA DE CITAS ---
        function configuringDuracion() {
            const s = document.getElementById('cita-servicio'); const d = document.getElementById('cita-duracion'); d.innerHTML = '';
            document.getElementById('div-duracion').classList.remove('hidden'); document.getElementById('div-fecha-hora').classList.remove('hidden');
            const t = s.options[s.selectedIndex].getAttribute('data-tipo');
            if (t === 'variable') {
                [30, 45, 60].forEach(v => d.innerHTML += `<option value="${v}">${v} Minutos</option>`);
            } else {
                d.innerHTML = '<option value="60" selected>60 Minutos</option>'; 
                if(document.getElementById('cita-fecha').value) cargarHorarios();
            }
        } window.configurarDuracion = configuringDuracion;

        function cargarHorarios() {
            const f = document.getElementById('cita-fecha').value; const t = document.getElementById('cita-duracion').value;
            const container = document.getElementById('slots-container'); const loading = document.getElementById('loading-slots');
            document.getElementById('cita-hora-seleccionada').value = "";
            if (!f || !t) return;
            let dCheck = parseInt(t); if(dCheck === 45) dCheck = 60;
            
            loading.classList.remove('hidden'); container.innerHTML = '';
            
            fetch(`${API_URL}?nocache=${new Date().getTime()}`, { 
                method: 'POST', body: JSON.stringify({ action: 'obtenerHorarios', fecha: f, duracionLogica: dCheck }) 
            })
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                if (data.error) { container.innerHTML = `<div class="text-red-500 font-bold col-span-full p-2">${data.error}</div>`; return; }
                if (data.horarios.length === 0) { container.innerHTML = '<div class="text-red-500 font-bold col-span-full">No hay horarios.</div>'; return; }
                data.horarios.forEach(slot => {
                    const div = document.createElement('div'); div.className = 'time-slot'; div.innerText = slot.val; 
                    div.onclick = () => { document.querySelectorAll('.time-slot').forEach(d => d.classList.remove('selected')); div.classList.add('selected'); document.getElementById('cita-hora-seleccionada').value = slot.val; };
                    container.appendChild(div);
                });
            }).catch(() => { loading.classList.add('hidden'); alert('Error conexi√≥n'); });
        }

        function enviarCita(e) {
            e.preventDefault(); const h = document.getElementById('cita-hora-seleccionada').value; if (!h) return alert("‚ö†Ô∏è Selecciona un horario.");
            const btn = document.getElementById('btn-cita'); const html = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Agendando...'; btn.disabled = true;
            
            // CONCATENACI√ìN CR√çTICA DE DNI
            const dniFull = document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value;

            const data = { action: 'nuevaCita', nombres: document.getElementById('cita-nombre').value, apellidos: document.getElementById('cita-apellido').value, dni: dniFull, email: document.getElementById('cita-email').value, whatsapp: document.getElementById('cita-whatsapp').value, fecha: document.getElementById('cita-fecha').value, hora: h, duracionReal: document.getElementById('cita-duracion').value, servicio: document.getElementById('cita-servicio').value };
            
            fetch(`${API_URL}?nocache=${new Date().getTime()}`, { method: 'POST', body: JSON.stringify(data) })
            .then(r => r.json())
            .then(result => {
                if (result.status === 'success') { 
                    alert(`‚úÖ ¬°Cita Confirmada para ${result.nombre}!\n\nüìÖ Fecha: ${result.fecha}\n‚è∞ Hora: ${data.hora}\n\nüìß IMPORTANTE: Hemos enviado los detalles a tu correo.`); 
                    e.target.reset(); document.getElementById('slots-container').innerHTML = ''; showSection('home'); 
                } 
                else { alert(`‚ö†Ô∏è ${result.message}`); cargarHorarios(); }
            }).finally(() => { btn.innerHTML = html; btn.disabled = false; });
        }

        // --- STAFF LOGIC (VENTAS Y ANULACIONES) ---
        function setStaffMode(mode) {
            const isAnulacion = mode === 'anulacion'; const isHistorial = mode === 'historial';
            const formVenta = document.getElementById('form-venta'); const viewHist = document.getElementById('staff-historial-view');
            
            ['venta','historial','anulacion'].forEach(t => document.getElementById(`tab-${t}`).className = 'flex-1 py-3 rounded-md font-bold text-fisioSub transition');
            document.getElementById(`tab-${mode}`).className = 'flex-1 py-3 rounded-md font-bold bg-white text-fisioPrimary shadow-sm transition';

            if(isHistorial) {
                formVenta.classList.add('hidden'); viewHist.classList.remove('hidden');
            } else {
                formVenta.classList.remove('hidden'); viewHist.classList.add('hidden');
                document.getElementById('venta-estado').value = isAnulacion ? 'Anulaci√≥n' : 'Venta';
                document.getElementById('div-anulacion-motivo').classList.toggle('hidden', !isAnulacion);
                document.getElementById('anulacion-motivo').required = isAnulacion;
                const btn = document.getElementById('btn-venta');
                if(isAnulacion) { 
                    btn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow text-lg transition'; 
                    btn.innerText = 'CONFIRMAR ANULACI√ìN'; 
                } else { 
                    btn.className = 'btn-action w-full text-white font-bold py-4 rounded-lg shadow-md text-lg transition'; 
                    btn.innerText = 'REGISTRAR'; 
                }
            }
        }

        function buscarPacienteVenta() {
            const dni = document.getElementById('venta-dni').value;
            fetch(`${API_URL}?nocache=${Date.now()}`, { method: 'POST', body: JSON.stringify({ action: 'buscarPaciente', dni: dni }) }).then(r => r.json()).then(d => {
                if(d.found){ document.getElementById('venta-paciente').value = d.nombres + ' ' + d.apellidos; document.getElementById('venta-celular').value = d.celular; document.getElementById('venta-email').value = d.email; } 
                else alert("Paciente no encontrado");
            });
        }

        function registrarVenta(e) {
            e.preventDefault(); const btn = document.getElementById('btn-venta'); btn.innerText = 'Guardando...'; btn.disabled = true;
            const data = { action: 'registrarVenta', usuarioLogueado: staffUser, terapeuta: document.getElementById('venta-terapeuta').value, paciente: document.getElementById('venta-paciente').value, fechaSesion: document.getElementById('venta-fecha').value, servicio: document.getElementById('venta-servicio').value, monto: document.getElementById('venta-monto').value, medioPago: document.getElementById('venta-pago').value, estado: document.getElementById('venta-estado').value, origen: document.getElementById('anulacion-motivo').value || 'Venta', dni: document.getElementById('venta-dni').value, email: document.getElementById('venta-email').value, celular: document.getElementById('venta-celular').value };
            fetch(`${API_URL}?nocache=${Date.now()}`, { method: 'POST', body: JSON.stringify(data) }).then(() => { alert('‚úÖ Registrado'); e.target.reset(); document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; setStaffMode('venta'); }).finally(() => { btn.innerText = 'REGISTRAR'; btn.disabled = false; });
        }
        function autoPrice(select) { const price = select.options[select.selectedIndex].getAttribute('data-price'); if(price) document.getElementById('venta-monto').value = price; }

        // --- GERENCIA & HISTORIA ---
        function cargarFinanzas() {
            const tbody = document.getElementById('tabla-resumen-body'); tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Cargando...</td></tr>';
            fetch(`${API_URL}?nocache=${Date.now()}`, { method: 'POST', body: JSON.stringify({action: 'obtenerFinanzas'}) }).then(r => r.json()).then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`; document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`; document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                tbody.innerHTML = ''; d.listaVentas.forEach(v => { tbody.innerHTML += `<tr class="border-b"><td class="p-4">${new Date(v[1]).toLocaleDateString()}</td><td class="p-4 font-bold">${v[4]}</td><td class="p-4 font-bold text-right">S/ ${v[6]}</td></tr>`; });
            });
        }
        function buscarHistorial(inputId, divId) {
             const t = document.getElementById(inputId || 'historia-search').value; const div = document.getElementById(divId || 'resultados-historia');
             fetch(`${API_URL}?nocache=${Date.now()}`, { method: 'POST', body: JSON.stringify({ action: 'buscarHistorialVentas', termino: t }) }).then(r => r.json()).then(d => {
                let h = '<table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2">Fecha</th><th class="p-2">Servicio</th><th class="p-2">S/</th></tr></thead><tbody>';
                d.forEach(v => h += `<tr><td class="p-2 border-b">${v.fecha}</td><td class="p-2 border-b">${v.servicio}</td><td class="p-2 border-b font-bold">${v.monto}</td></tr>`);
                div.innerHTML = d.length ? h+'</tbody></table>' : 'Sin datos'; div.classList.remove('hidden');
            });
        }
        function buscarHistoria() { buscarHistorial('historia-search', 'resultados-historia'); }
        function guardarHistoria(e) { e.preventDefault(); alert('‚úÖ Evoluci√≥n guardada (Simulaci√≥n Frontend).'); e.target.reset(); }
        
        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => { if(document.getElementById('venta-fecha')) document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; });

    </script>
</body>
</html>