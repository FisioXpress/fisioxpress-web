<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fisioPrimary: '#1B4D3E', 
                        fisioAccent: '#4CAF50',  
                        fisioLight: '#F1F8E9',   
                        fisioHover: '#2E7D32',   
                        fisioOrange: '#FF9800',  
                        fisioOrangeHover: '#F57C00' 
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { background-color: #F1F8E9; }
        input[type="date"], select { -webkit-appearance: none; appearance: none; }
        .time-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        option:disabled { background-color: #e5e7eb; color: #9ca3af; }
        /* Animación para el autocompletado */
        .autofill-pulse { animation: pulseGreen 1s; }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    </style>
</head>
<body class="text-gray-800 font-sans">

    <nav class="bg-fisioPrimary text-white p-3 shadow-lg sticky top-0 z-50 border-b-4 border-fisioAccent">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center cursor-pointer gap-3" onclick="showSection('home')">
                <img src="https://lh3.googleusercontent.com/d/1-Oryehjw29qzgFZo9mIpWB-HpldPkNQx" alt="Logo" class="h-14 bg-white rounded-lg p-1 shadow-sm" onerror="this.src='https://ui-avatars.com/api/?name=Fisio+Xpress&background=1B4D3E&color=fff'">
                <h1 class="text-xl font-bold tracking-widest hidden md:block">FISIOXPRESS</h1>
            </div>
            <button onclick="showSection('home')" class="text-sm bg-fisioOrange hover:bg-fisioOrangeHover text-white px-4 py-2 rounded-lg transition flex items-center gap-2 shadow-sm font-bold">
                <i class="fa-solid fa-home"></i> <span class="hidden md:inline">Menú Principal</span>
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-12 mt-8">
            <h2 class="text-4xl font-extrabold text-fisioPrimary mb-3">Bienvenido a FisioXpress</h2>
            <p class="text-lg text-gray-600">Tu bienestar en las mejores manos.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-6xl mx-auto">
            <div onclick="showSection('app-citas')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioOrange group transform hover:-translate-y-2">
                <div class="text-fisioAccent group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-calendar-check"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Citas</h3>
                <p class="text-sm text-center text-gray-500">Agenda aquí. Atención hasta 8:00 PM</p>
            </div>
            <div onclick="checkAuth('staff')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioPrimary group transform hover:-translate-y-2">
                <div class="text-fisioPrimary group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-cash-register"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Control Interno</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Ventas y Caja.</p>
            </div>
            <div onclick="checkAuth('staff_historia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioAccent group transform hover:-translate-y-2">
                <div class="text-fisioAccent group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-file-medical-alt"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Historias</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Evolución Pacientes.</p>
            </div>
            <div onclick="checkAuth('gerencia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-gray-800 group transform hover:-translate-y-2">
                <div class="text-gray-800 group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-chart-pie"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Gerencia</h3>
                <p class="text-sm text-center text-gray-500">Dashboard y Gastos.</p>
            </div>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20 pt-6">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioOrange">
            <h2 class="text-3xl font-bold text-fisioPrimary mb-8 text-center"><i class="fa-solid fa-calendar-days text-fisioOrange"></i> Reservar Cita</h2>
            <div class="bg-orange-50 p-4 rounded-lg mb-6 border-l-4 border-fisioOrange text-sm text-orange-800 flex items-start gap-2">
                <i class="fa-solid fa-circle-info mt-1 text-fisioOrange"></i>
                <div><strong>Horario de Atención:</strong> Lunes a Sábado de 9:00 am a 8:00 pm.<br><span class="text-xs opacity-80">Domingos y Feriados cerrado.</span></div>
            </div>

            <form id="form-cita" onsubmit="enviarCita(event)">
                <p class="font-bold text-fisioPrimary mb-3 border-b border-gray-100 pb-2">Datos Personales</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cita-nombre" placeholder="INGRESE SU NOMBRE" required class="p-3 border rounded bg-gray-50 w-full focus:border-fisioOrange outline-none transition">
                    <input type="text" id="cita-apellido" placeholder="INGRESE SU APELLIDO" required class="p-3 border rounded bg-gray-50 w-full focus:border-fisioOrange outline-none transition">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="cita-doc-tipo" class="p-3 border rounded bg-gray-50 focus:border-fisioOrange outline-none transition"><option>DNI</option><option>C.E.</option><option>Pasaporte</option></select>
                    <input type="text" id="cita-doc-num" placeholder="N° Documento" required class="p-3 border rounded bg-gray-50 col-span-2 w-full focus:border-fisioOrange outline-none transition">
                </div>
                <div class="mb-4"><input type="email" id="cita-email" placeholder="Correo Electrónico (Para envío de confirmación)" required class="p-3 border rounded w-full bg-gray-50 focus:border-fisioOrange outline-none transition"></div>
                <div class="mb-4"><input type="tel" id="cita-whatsapp" placeholder="Número de Teléfono" required class="p-3 border rounded w-full bg-gray-50 focus:border-fisioOrange outline-none transition"></div>

                <p class="font-bold text-fisioPrimary mb-3 border-b border-gray-100 pb-2 mt-8">Fecha y Hora</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">FECHA</label><input type="date" id="cita-fecha" required class="w-full p-3 border rounded bg-white font-medium focus:border-fisioOrange outline-none transition" onchange="verificarDisponibilidad(this)"></div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">HORA</label>
                        <select id="cita-hora" required class="time-select w-full p-3 border rounded bg-white font-medium focus:border-fisioOrange outline-none disabled:bg-gray-100 disabled:text-gray-400">
                            <option value="">Seleccionar...</option>
                            <option value="09:00">09:00 AM</option><option value="09:30">09:30 AM</option><option value="10:00">10:00 AM</option><option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option><option value="11:30">11:30 AM</option><option value="12:00">12:00 PM</option><option value="12:30">12:30 PM</option>
                            <option value="13:00">01:00 PM</option><option value="13:30">01:30 PM</option><option value="14:00">02:00 PM</option><option value="14:30">02:30 PM</option>
                            <option value="15:00">03:00 PM</option><option value="15:30">03:30 PM</option><option value="16:00">04:00 PM</option><option value="16:30">04:30 PM</option>
                            <option value="17:00">05:00 PM</option><option value="17:30">05:30 PM</option><option value="18:00">06:00 PM</option><option value="18:30">06:30 PM</option>
                            <option value="19:00">07:00 PM</option><option value="19:30">07:30 PM (Último Turno)</option>
                        </select>
                        <p id="loading-hours" class="text-xs text-fisioOrange font-bold mt-1 hidden"><i class="fa-solid fa-spinner fa-spin"></i> Verificando horarios...</p>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="text-xs font-bold text-gray-400 block mb-1">SERVICIO</label>
                    <select id="cita-servicio" class="p-3 border rounded w-full bg-white font-medium focus:border-fisioOrange outline-none transition">
                        <option>Evaluación Fisioterapéutica</option><option>Masaje Relajante</option><option>Masaje Xpress Focalizado</option>
                        <option>Masaje Descontracturante</option><option>Masaje Deportivo</option><option>Drenaje Linfático</option>
                        <option>Fisioterapia Especializada</option><option>Paquete de Tratamiento</option>
                    </select>
                </div>
                <button type="submit" id="btn-cita" class="w-full bg-fisioOrange hover:bg-fisioOrangeHover text-white font-extrabold py-4 rounded-xl transition shadow-lg text-lg flex justify-center items-center gap-2">
                    CONFIRMAR Y ENVIAR <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20 pt-6">
        <div class="flex justify-between items-center mb-6 bg-white p-5 rounded-2xl shadow-md border-l-8 border-fisioPrimary">
            <h2 class="text-2xl font-bold text-fisioPrimary flex items-center gap-3"><i class="fa-solid fa-clipboard-list"></i> Control Interno</h2>
            <div class="bg-fisioLight p-2 px-4 rounded-full text-fisioPrimary border border-fisioAccent flex items-center gap-2">
                <i class="fa-solid fa-user-check"></i> <span id="staff-name-display" class="font-bold">Staff</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex p-1 bg-gray-100 rounded-xl mb-8">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-fisioAccent shadow-md">Nueva Venta</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:text-fisioOrange transition-all">Anulación</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta"> 
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                     <div><label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Fecha Sesión</label><input type="date" id="venta-fecha" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required></div>
                    <div><label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Terapeuta</label><select id="venta-terapeuta" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required><option value="">Seleccionar...</option><option>Ana Pisfil</option><option>Isabel Barriga</option><option>Carmen Rodriguez</option></select></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div><label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Nombre</label><input type="text" id="venta-nombre" placeholder="INGRESE SU NOMBRE" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required></div>
                    <div><label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Apellido</label><input type="text" id="venta-apellido" placeholder="INGRESE SU APELLIDO" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required></div>
                     
                     <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Documento</label>
                        <div class="flex gap-2">
                             <select id="venta-doc-tipo" class="p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none w-1/3 text-sm">
                                <option>DNI</option><option>C.E.</option><option>Pasaporte</option>
                             </select>
                             <input type="text" id="venta-doc-num" placeholder="Número" class="w-2/3 p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="col-span-2">
                         <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Servicio / Producto</label>
                         <div class="flex gap-3">
                            <select id="venta-servicio-select" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none transition" required onchange="checkCustomService(this)">
                                <option value="">Seleccionar...</option>
                                <option>Masaje Relajante</option>
                                <option>Masaje Xpress Focalizado</option>
                                <option>Masaje Descontracturante</option>
                                <option>Masaje Deportivo</option>
                                <option>Drenaje Linfático</option>
                                <option>Fisioterapia Especializada</option>
                                <option value="custom">Producto / Otro ➡️</option>
                            </select>
                            <input type="text" id="venta-detalle-custom" placeholder="Especifique..." class="hidden w-full p-3 border-2 border-fisioOrange rounded-lg bg-orange-50 font-bold focus:border-fisioOrangeHover outline-none transition fade-in">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Duración</label>
                        <div class="flex gap-2">
                            <select id="venta-duracion" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required onchange="checkCustomDuration(this)">
                                <option value="30">30 min</option>
                                <option value="45">45 min</option>
                                <option value="60">60 min</option>
                                <option value="80">80 min</option>
                                <option value="0">No Aplica</option>
                                <option value="Otra">Otra Duración</option>
                            </select>
                            <input type="number" id="venta-duracion-custom" placeholder="Min" class="hidden w-1/2 p-3 border-2 border-fisioOrange rounded-lg bg-orange-50 font-bold focus:border-fisioOrangeHover outline-none transition fade-in">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div><label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Medio de Pago</label><select id="venta-pago" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required><option>YAPE/PLIN</option><option>EFECTIVO</option><option>TARJETA</option></select></div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Captación</label>
                        <div class="flex gap-2">
                             <select id="venta-captacion" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required onchange="checkCustomCaptacion(this)">
                                <option>Redes Sociales</option>
                                <option>Flyers</option>
                                <option>Referidos</option>
                                <option>Banners</option>
                                <option>Cliente Recurrente</option>
                                <option value="custom">Otro ➡️</option>
                            </select>
                             <input type="text" id="venta-captacion-custom" placeholder="Detalle..." class="hidden w-full p-3 border-2 border-gray-100 rounded-lg bg-gray-50 focus:border-fisioAccent outline-none transition fade-in">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Monto Total (S/)</label>
                        <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-full p-3 border-2 border-fisioAccent rounded-lg text-3xl font-extrabold text-fisioAccent text-right focus:ring-0 outline-none bg-white transition" required>
                    </div>
                </div>

                <div id="div-anulacion-motivo" class="hidden mb-8 bg-orange-50 p-6 rounded-xl border-2 border-fisioOrange fade-in">
                    <label class="block text-fisioOrange font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Motivo de la Anulación (Obligatorio)</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error de digitación..." class="w-full p-4 border-2 border-orange-200 rounded-lg focus:border-fisioOrange outline-none bg-white">
                </div>

                <button type="submit" id="btn-venta" class="w-full bg-fisioAccent hover:bg-fisioPrimary text-white font-extrabold py-4 rounded-xl text-xl shadow-md transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-save"></i> REGISTRAR OPERACIÓN
                </button>
            </form>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20 pt-6">
        <div class="flex items-center gap-4 mb-6 bg-white p-5 rounded-2xl shadow-md border-b-4 border-fisioAccent">
            <div class="bg-fisioAccent p-3 rounded-xl text-white"><i class="fa-solid fa-heart-pulse text-2xl"></i></div>
            <h2 class="text-2xl font-bold text-fisioPrimary">Historias Clínicas</h2>
        </div>
        
        <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-fisioPrimary">
            <h3 class="text-xl font-bold mb-6 text-fisioPrimary flex items-center gap-2"><i class="fa-solid fa-pen-fancy"></i> Evolución / Historia</h3>
            <form onsubmit="guardarHistoria(event)">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="relative">
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Documento</label>
                        <div class="flex gap-2">
                             <select id="hc-doc-tipo" class="p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none w-1/3 text-sm">
                                <option>DNI</option><option>C.E.</option><option>Pasaporte</option>
                             </select>
                             <input type="text" id="hc-doc-num" placeholder="Número..." class="w-2/3 p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none font-bold" required onblur="autocompletarDatos(this)">
                        </div>
                        <p id="hc-loading" class="text-xs text-fisioOrange font-bold mt-1 hidden"><i class="fa-solid fa-spinner fa-spin"></i> Buscando paciente...</p>
                    </div>

                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Nombre</label>
                            <input id="hc-nombre" placeholder="Nombre" class="w-full p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none transition" required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Apellido</label>
                            <input id="hc-apellido" placeholder="Apellido" class="w-full p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none transition" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Edad</label>
                        <input id="hc-edad" placeholder="Edad" class="w-full p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <textarea id="hc-motivo" placeholder="Motivo Consulta" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                    <textarea id="hc-antecedentes" placeholder="Antecedentes" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                     <div class="p-6 border-2 border-gray-100 rounded-lg bg-fisioLight">
                        <label class="block font-bold mb-4 text-fisioPrimary">Nivel de Dolor (EVA 1-10)</label>
                        <div class="flex items-center gap-6">
                            <span class="text-2xl font-extrabold text-fisioAccent" id="eva-display">1</span>
                            <input type="range" min="1" max="10" value="1" class="w-full accent-fisioAccent h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('eva-display').innerText = this.value; document.getElementById('hc-eva').value = this.value"><input type="hidden" id="hc-eva" value="1">
                        </div>
                     </div>
                     <textarea id="hc-tratamiento" placeholder="Tratamiento..." class="p-4 border-2 border-gray-100 rounded-lg h-full focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <button class="bg-fisioPrimary hover:bg-fisioHover text-white font-extrabold px-8 py-4 rounded-xl w-full shadow-lg transition text-lg">GUARDAR HISTORIA</button>
            </form>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-fisioPrimary bg-opacity-90 hidden flex items-center justify-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm relative">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-fisioAccent"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-2xl font-extrabold text-fisioPrimary text-center mb-6">Acceso Restringido</h3>
            <div id="div-user-auth" class="hidden mb-4">
                <label class="block text-left text-gray-500 font-bold mb-1 text-sm ml-1">Tu Nombre (Obligatorio)</label>
                <input type="text" id="input-user" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center font-medium text-gray-700 outline-none focus:border-fisioAccent" placeholder="Ingresa tu nombre">
            </div>
            <label class="block text-left text-gray-500 font-bold mb-1 text-sm ml-1">Contraseña</label>
            <input type="password" id="input-pass" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-2xl font-bold text-fisioPrimary focus:border-fisioAccent outline-none mb-6" placeholder="••••••">
            <button onclick="verifyPass()" class="w-full py-4 bg-fisioAccent text-white font-extrabold rounded-xl hover:bg-fisioPrimary transition shadow-lg text-lg">DESBLOQUEAR</button>
        </div>
    </div>

    <script>
        // PEGA AQUÍ TU URL ACTUALIZADA SI ES NECESARIO (O USA LA MISMA SI SOLO ACTUALIZASTE EL SCRIPT)
        const API_URL = 'https://script.google.com/macros/s/AKfycbyrMDIxUyyHlITYI3mpoxysx73YOTKkGJfwC55cNPCVZn6RnKRNwMAvq_Y4m0gjv9ZxlQ/exec'; 

        let currentTarget = '';
        let staffUser = 'Anónimo';

        function formatDate(dateString) { const date = new Date(dateString); return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`; }

        document.addEventListener('DOMContentLoaded', () => {
             const hoy = new Date().toISOString().split('T')[0];
             if(document.getElementById('venta-fecha')) document.getElementById('venta-fecha').value = hoy;
             if(document.getElementById('cita-fecha')) {
                 const fechaInput = document.getElementById('cita-fecha');
                 fechaInput.value = hoy;
                 fechaInput.min = hoy; 
                 verificarDisponibilidad(fechaInput);
             }
             if(document.getElementById('gasto-fecha')) document.getElementById('gasto-fecha').value = hoy;
        });

        // --- NUEVA FUNCIÓN: AUTOCOMPLETADO DE DATOS ---
        function autocompletarDatos(inputDni) {
            const dni = inputDni.value;
            if (dni.length < 5) return; // No buscar si es muy corto

            const loader = document.getElementById('hc-loading');
            const inputNombre = document.getElementById('hc-nombre');
            const inputApellido = document.getElementById('hc-apellido');
            
            loader.classList.remove('hidden');

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'buscarCliente', dni: dni })
            })
            .then(r => r.json())
            .then(data => {
                loader.classList.add('hidden');
                if (data.status === 'success') {
                    // Efecto visual de encontrado
                    inputNombre.value = data.data.nombre;
                    inputApellido.value = data.data.apellido;
                    inputNombre.classList.add('autofill-pulse');
                    inputApellido.classList.add('autofill-pulse');
                    setTimeout(() => {
                        inputNombre.classList.remove('autofill-pulse');
                        inputApellido.classList.remove('autofill-pulse');
                    }, 1000);
                }
            })
            .catch(e => {
                console.error("Error buscando cliente", e);
                loader.classList.add('hidden');
            });
        }

        function guardarHistoria(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button'); 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true;

            const dniFull = document.getElementById('hc-doc-tipo').value + ' ' + document.getElementById('hc-doc-num').value;
            
            const data = {
                action: 'guardarHistoria',
                dni: dniFull,
                nombre: document.getElementById('hc-nombre').value,
                apellido: document.getElementById('hc-apellido').value,
                edad: document.getElementById('hc-edad').value,
                motivo: document.getElementById('hc-motivo').value,
                antecedentes: document.getElementById('hc-antecedentes').value,
                eva: document.getElementById('hc-eva').value,
                tratamiento: document.getElementById('hc-tratamiento').value
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { 
                alert('✅ Historia Clínica Guardada'); 
                e.target.reset(); 
            })
            .finally(() => { 
                btn.innerHTML = 'GUARDAR HISTORIA'; btn.disabled = false; 
            });
        }

        // --- RESTO DE FUNCIONES (SIN CAMBIOS) ---
        function validarFecha(input) { if (new Date(input.value).getUTCDay() === 0) { alert("⛔ Domingos cerrado."); input.value = ""; } }

        function verificarDisponibilidad(input) {
            const fecha = input.value;
            if (new Date(fecha).getUTCDay() === 0) { alert("⛔ Domingos cerrado."); input.value = ""; return; }
            const selectHora = document.getElementById('cita-hora');
            const loading = document.getElementById('loading-hours');
            const opciones = selectHora.options;
            for(let i=0; i<opciones.length; i++) { opciones[i].disabled = false; opciones[i].innerText = opciones[i].innerText.replace(" (Ocupado)", ""); }
            loading.classList.remove('hidden'); 
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'obtenerHorarios', fecha: fecha}) })
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                if(data.ocupados && data.ocupados.length > 0) {
                    for(let i=0; i<opciones.length; i++) {
                        if (data.ocupados.includes(opciones[i].value)) {
                            opciones[i].disabled = true;
                            opciones[i].innerText += " (Ocupado)";
                        }
                    }
                }
            })
            .catch(e => { console.error("Error", e); loading.classList.add('hidden'); });
        }

        function checkCustomService(select) {
            const customInput = document.getElementById('venta-detalle-custom');
            const duracionSelect = document.getElementById('venta-duracion');
            if (select.value === 'custom') {
                customInput.classList.remove('hidden'); customInput.required = true;
                select.classList.remove('w-full'); select.classList.add('w-1/2'); customInput.classList.add('w-1/2'); customInput.focus();
                duracionSelect.value = "0"; checkCustomDuration(duracionSelect); 
            } else {
                customInput.classList.add('hidden'); customInput.required = false;
                select.classList.remove('w-1/2'); select.classList.add('w-full');
            }
        }

        function checkCustomDuration(select) {
            const customInput = document.getElementById('venta-duracion-custom');
            if (select.value === 'Otra') {
                customInput.classList.remove('hidden'); customInput.required = true;
                select.classList.remove('w-full'); select.classList.add('w-1/2'); customInput.classList.add('w-1/2'); customInput.focus();
            } else {
                customInput.classList.add('hidden'); customInput.required = false;
                select.classList.remove('w-1/2'); select.classList.add('w-full');
            }
        }

        function checkCustomCaptacion(select) {
            const customInput = document.getElementById('venta-captacion-custom');
            if (select.value === 'custom') {
                customInput.classList.remove('hidden'); customInput.required = true;
                select.classList.remove('w-full'); select.classList.add('w-1/2'); customInput.classList.add('w-1/2'); customInput.focus();
            } else {
                customInput.classList.add('hidden'); customInput.required = false;
                select.classList.remove('w-1/2'); select.classList.add('w-full');
            }
        }

        function registrarVenta(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-venta');
            const selectServicio = document.getElementById('venta-servicio-select');
            let servicioFinal = selectServicio.value === 'custom' ? document.getElementById('venta-detalle-custom').value : selectServicio.options[selectServicio.selectedIndex].text;
            const selectDuracion = document.getElementById('venta-duracion');
            let duracionFinal = selectDuracion.value;
            if (duracionFinal === 'Otra') {
                const customVal = document.getElementById('venta-duracion-custom').value;
                const prohibidos = ['30', '45', '60', '80', '0'];
                if (prohibidos.includes(customVal)) { alert('⚠️ Error: La duración ingresada (' + customVal + ') ya existe en la lista. Por favor, selecciónela del menú desplegable.'); return; }
                duracionFinal = customVal;
            }
            const selectCaptacion = document.getElementById('venta-captacion');
            let captacionFinal = selectCaptacion.value === 'custom' ? document.getElementById('venta-captacion-custom').value : selectCaptacion.value;
            const dniFinal = document.getElementById('venta-doc-tipo').value + ' ' + document.getElementById('venta-doc-num').value;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true;
            const data = { action: 'registrarVenta', usuarioLogueado: staffUser, terapeuta: document.getElementById('venta-terapeuta').value, nombre: document.getElementById('venta-nombre').value, apellido: document.getElementById('venta-apellido').value, dni: dniFinal, fechaSesion: document.getElementById('venta-fecha').value, servicio: servicioFinal, duracion: duracionFinal, captacion: captacionFinal, monto: document.getElementById('venta-monto').value, medioPago: document.getElementById('venta-pago').value, estado: document.getElementById('venta-estado').value, origen: document.getElementById('anulacion-motivo').value || 'Venta' };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { alert('✅ Registrado'); e.target.reset(); document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; checkCustomService(document.getElementById('venta-servicio-select')); checkCustomCaptacion(document.getElementById('venta-captacion')); checkCustomDuration(document.getElementById('venta-duracion')); setStaffMode('venta'); })
            .finally(() => { btn.innerHTML = '<i class="fa-solid fa-save"></i> REGISTRAR OPERACIÓN'; btn.disabled = false; });
        }

        function registrarGasto(e) {
            e.preventDefault();
            if(!confirm("¿Confirmar Gasto?")) return;
            const btn = e.target.querySelector('button'); btn.disabled = true;
            const data = { action: 'registrarGasto', tipo: 'Gasto', fechaGasto: document.getElementById('gasto-fecha').value, categoria: document.getElementById('gasto-categoria').value, concepto: document.getElementById('gasto-concepto').value, monto: document.getElementById('gasto-monto').value, usuario: 'Gerencia' };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(() => { alert('✅ Gasto Guardado'); e.target.reset(); document.getElementById('gasto-fecha').value = new Date().toISOString().split('T')[0]; cargarFinanzas(); }).finally(() => { btn.disabled = false; });
        }

        function anularGasto(concepto, monto) {
            if(!confirm("⚠️ ¿ANULAR gasto de S/" + monto + "?")) return;
            const data = { action: 'registrarGasto', tipo: 'Anulacion', fechaGasto: new Date().toISOString().split('T')[0], categoria: 'Anulación', concepto: 'ANULACIÓN: ' + concepto, monto: monto, usuario: 'Gerencia' };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(() => { alert('✅ Anulado'); cargarFinanzas(); });
        }

        function cargarFinanzas() {
            const tbodyV = document.getElementById('tabla-resumen-body'); const tbodyG = document.getElementById('tabla-gastos-body');
            tbodyV.innerHTML = tbodyG.innerHTML = '<tr><td colspan="4" class="text-center p-4 italic"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</td></tr>';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'obtenerFinanzas'}) }).then(r => r.json()).then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`; document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`; document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                let htmlV = ''; d.listaVentas.forEach(v => { htmlV += `<tr class="hover:bg-green-50 border-b"><td class="p-3">${formatDate(v[0])}</td><td class="p-3 font-bold text-fisioPrimary">${v[3]}</td><td class="p-3 text-sm">${v[7]}</td><td class="p-3 font-bold text-right text-fisioAccent">S/ ${v[9]}</td></tr>`; }); tbodyV.innerHTML = htmlV || '<tr><td colspan="4" class="text-center p-4 text-gray-400">Sin datos</td></tr>';
                let htmlG = ''; d.listaGastos.forEach(g => { let monto = g[4]; let btnAnular = monto > 0 ? `<button onclick="anularGasto('${g[2]}', ${monto})" class="text-fisioOrange font-bold hover:text-red-600">X</button>` : '-'; htmlG += `<tr class="hover:bg-orange-50 border-b"><td class="p-3">${formatDate(g[1])}</td><td class="p-3">${g[2]}</td><td class="p-3 font-bold text-right ${monto < 0 ? 'text-red-500' : 'text-fisioOrange'}">S/ ${monto}</td><td class="p-3 text-center">${btnAnular}</td></tr>`; }); tbodyG.innerHTML = htmlG || '<tr><td colspan="4" class="text-center p-4 text-gray-400">Sin datos</td></tr>';
            });
        }

        function showSection(id) { document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none'); document.getElementById(id).style.display = 'block'; window.scrollTo(0,0); }
        
        function checkAuth(target) { 
            currentTarget = target; 
            document.getElementById('modal-auth').classList.remove('hidden'); 
            document.getElementById('input-pass').value = ''; 
            document.getElementById('input-user').value = '';
            const userDiv = document.getElementById('div-user-auth');
            if (target.includes('staff')) {
                userDiv.classList.remove('hidden'); 
                document.getElementById('input-user').focus(); 
            } else {
                userDiv.classList.add('hidden'); 
                document.getElementById('input-pass').focus();
            }
        }
        
        function closeModal() { document.getElementById('modal-auth').classList.add('hidden'); }
        
        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            const userName = document.getElementById('input-user').value.trim();
            if (currentTarget.includes('staff')) { 
                if (pass === 'Fisio.123') { 
                    if (userName === "") { alert("⚠️ Por favor, ingresa tu nombre para continuar."); return; }
                    staffUser = userName; 
                    document.getElementById('staff-name-display').innerText = staffUser; 
                    closeModal(); 
                    showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia'); 
                } else { alert('⛔ Clave incorrecta'); }
            } else if (currentTarget === 'gerencia') { 
                if (pass === 'marioyavril.') { closeModal(); showSection('app-gerencia'); cargarFinanzas(); } else { alert('⛔ Clave incorrecta'); }
            }
        }
        
        function enviarCita(e) {
            e.preventDefault(); const btn = document.getElementById('btn-cita'); const originalHtml = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando reserva...'; btn.disabled = true;
            const data = { action: 'nuevaCita', nombre: document.getElementById('cita-nombre').value, apellido: document.getElementById('cita-apellido').value, dni: document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value, email: document.getElementById('cita-email').value, whatsapp: document.getElementById('cita-whatsapp').value, fecha: document.getElementById('cita-fecha').value, hora: document.getElementById('cita-hora').value, servicio: document.getElementById('cita-servicio').value };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(() => { 
                alert('Su cita ha sido agendada, en breve recibirá el correo de confirmación. En caso de cualquier consulta, no dude en comunicarse a nuestro número de Whatsapp.\n\nIMPORTANTE: Recuerde asistir de manera puntual a su cita');
                e.target.reset(); showSection('home'); 
            }).finally(() => { btn.innerHTML = originalHtml; btn.disabled = false; });
        }
        function setStaffMode(mode) {
            const estadoInput = document.getElementById('venta-estado'); const btn = document.getElementById('btn-venta'); const motivoDiv = document.getElementById('div-anulacion-motivo'); const montoInput = document.getElementById('venta-monto');
            if (mode === 'anulacion') {
                estadoInput.value = 'Anulación'; btn.classList.replace('bg-fisioAccent', 'bg-fisioOrange'); btn.innerHTML = 'CONFIRMAR ANULACIÓN'; motivoDiv.classList.remove('hidden'); document.getElementById('anulacion-motivo').required = true;
                montoInput.classList.replace('text-fisioAccent', 'text-fisioOrange'); montoInput.classList.replace('border-fisioAccent', 'border-fisioOrange');
            } else {
                estadoInput.value = 'Venta'; btn.classList.replace('bg-fisioOrange', 'bg-fisioAccent'); btn.innerHTML = 'REGISTRAR OPERACIÓN'; motivoDiv.classList.add('hidden'); document.getElementById('anulacion-motivo').required = false;
                montoInput.classList.replace('text-fisioOrange', 'text-fisioAccent'); montoInput.classList.replace('border-fisioOrange', 'border-fisioAccent');
            }
        }
    </script>
</body>
</html>