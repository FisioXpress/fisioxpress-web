<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fisioPrimary: '#1B4D3E', // Verde Corporativo
                        fisioAccent: '#4CAF50',  // Verde Vibrante
                        fisioLight: '#F1F8E9',   // Fondo Suave
                        fisioHover: '#2E7D32',   // Verde Interacción
                        fisioOrange: '#FF9800',  // Naranja (Acento)
                        fisioOrangeHover: '#F57C00' // Naranja Oscuro
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { background-color: #F1F8E9; }
        input[type="date"], select { -webkit-appearance: none; appearance: none; }
        /* Icono de flecha para selects */
        .time-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
    </style>
</head>
<body class="text-gray-800 font-sans">

    <nav class="bg-fisioPrimary text-white p-3 shadow-lg sticky top-0 z-50 border-b-4 border-fisioAccent">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center cursor-pointer gap-3" onclick="showSection('home')">
                <img src="https://lh3.googleusercontent.com/d/1-Oryehjw29qzgFZo9mIpWB-HpldPkNQx" alt="Logo" class="h-14 bg-white rounded-lg p-1 shadow-sm" onerror="this.src='https://ui-avatars.com/api/?name=Fisio+Xpress&background=1B4D3E&color=fff'">
                <h1 class="text-xl font-bold tracking-widest hidden md:block">FISIOXPRESS</h1>
            </div>
            <button onclick="showSection('home')" class="text-sm bg-fisioOrange hover:bg-fisioOrangeHover text-white px-4 py-2 rounded-lg transition flex items-center gap-2 shadow-sm font-bold">
                <i class="fa-solid fa-home"></i> <span class="hidden md:inline">Menú Principal</span>
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-12 mt-8">
            <h2 class="text-4xl font-extrabold text-fisioPrimary mb-3">Bienvenido a FisioXpress</h2>
            <p class="text-lg text-gray-600">Tu bienestar en las mejores manos.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-6xl mx-auto">
            <div onclick="showSection('app-citas')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioOrange group transform hover:-translate-y-2">
                <div class="text-fisioAccent group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-calendar-check"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Citas</h3>
                <p class="text-sm text-center text-gray-500">Agenda aquí. Atención hasta 8:00 PM</p>
            </div>
            <div onclick="checkAuth('staff')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioPrimary group transform hover:-translate-y-2">
                <div class="text-fisioPrimary group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-cash-register"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Control Interno</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Ventas y Caja.</p>
            </div>
            <div onclick="checkAuth('staff_historia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-fisioAccent group transform hover:-translate-y-2">
                <div class="text-fisioAccent group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-file-medical-alt"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Historias</h3>
                <p class="text-sm text-center text-gray-500">Acceso Staff. Evolución Pacientes.</p>
            </div>
            <div onclick="checkAuth('gerencia')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-2xl transition cursor-pointer border-b-8 border-gray-800 group transform hover:-translate-y-2">
                <div class="text-gray-800 group-hover:text-fisioOrange text-5xl mb-6 text-center transition"><i class="fa-solid fa-chart-pie"></i></div>
                <h3 class="text-2xl font-bold text-center mb-3 text-fisioPrimary">Gerencia</h3>
                <p class="text-sm text-center text-gray-500">Dashboard y Gastos.</p>
            </div>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20 pt-6">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioOrange">
            <h2 class="text-3xl font-bold text-fisioPrimary mb-8 text-center"><i class="fa-solid fa-calendar-days text-fisioOrange"></i> Reservar Cita</h2>
            
            <div class="bg-orange-50 p-4 rounded-lg mb-6 border-l-4 border-fisioOrange text-sm text-orange-800 flex items-start gap-2">
                <i class="fa-solid fa-circle-info mt-1 text-fisioOrange"></i>
                <div>
                    <strong>Horario de Atención:</strong> Lunes a Sábado de 9:00 am a 8:00 pm.<br>
                    <span class="text-xs opacity-80">Domingos y Feriados cerrado.</span>
                </div>
            </div>

            <form id="form-cita" onsubmit="enviarCita(event)">
                <p class="font-bold text-fisioPrimary mb-3 border-b border-gray-100 pb-2">Datos Personales</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cita-nombre" placeholder="Nombres" required class="p-3 border rounded bg-gray-50 w-full focus:border-fisioOrange outline-none transition">
                    <input type="text" id="cita-apellido" placeholder="Apellidos" required class="p-3 border rounded bg-gray-50 w-full focus:border-fisioOrange outline-none transition">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="cita-doc-tipo" class="p-3 border rounded bg-gray-50 focus:border-fisioOrange outline-none transition"><option>DNI</option><option>C.E.</option><option>Pasaporte</option></select>
                    <input type="text" id="cita-doc-num" placeholder="N° Documento" required class="p-3 border rounded bg-gray-50 col-span-2 w-full focus:border-fisioOrange outline-none transition">
                </div>
                <div class="mb-4">
                    <input type="email" id="cita-email" placeholder="Correo Electrónico (Para envío de confirmación)" required class="p-3 border rounded w-full bg-gray-50 focus:border-fisioOrange outline-none transition">
                </div>
                <div class="mb-4">
                    <input type="tel" id="cita-whatsapp" placeholder="WhatsApp" required class="p-3 border rounded w-full bg-gray-50 focus:border-fisioOrange outline-none transition">
                </div>

                <p class="font-bold text-fisioPrimary mb-3 border-b border-gray-100 pb-2 mt-8">Fecha y Hora</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">FECHA</label>
                        <input type="date" id="cita-fecha" required class="w-full p-3 border rounded bg-white font-medium focus:border-fisioOrange outline-none transition" onchange="validarFecha(this)">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">HORA</label>
                        <select id="cita-hora" required class="time-select w-full p-3 border rounded bg-white font-medium focus:border-fisioOrange outline-none">
                            <option value="">Seleccionar...</option>
                            <option value="09:00">09:00 AM</option>
                            <option value="09:30">09:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">01:00 PM</option>
                            <option value="13:30">01:30 PM</option>
                            <option value="14:00">02:00 PM</option>
                            <option value="14:30">02:30 PM</option>
                            <option value="15:00">03:00 PM</option>
                            <option value="15:30">03:30 PM</option>
                            <option value="16:00">04:00 PM</option>
                            <option value="16:30">04:30 PM</option>
                            <option value="17:00">05:00 PM</option>
                            <option value="17:30">05:30 PM</option>
                            <option value="18:00">06:00 PM</option>
                            <option value="18:30">06:30 PM</option>
                            <option value="19:00">07:00 PM (Último Turno)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="text-xs font-bold text-gray-400 block mb-1">SERVICIO</label>
                    <select id="cita-servicio" class="p-3 border rounded w-full bg-white font-medium focus:border-fisioOrange outline-none transition">
                        <option>Evaluación Fisioterapéutica</option>
                        <option>Masaje Relajante</option>
                        <option>Masaje Xpress Focalizado</option>
                        <option>Masaje Descontracturante</option>
                        <option>Masaje Deportivo</option>
                        <option>Drenaje Linfático</option>
                        <option>Fisioterapia Especializada</option>
                        <option>Paquete de Tratamiento</option>
                    </select>
                </div>
                <button type="submit" id="btn-cita" class="w-full bg-fisioOrange hover:bg-fisioOrangeHover text-white font-extrabold py-4 rounded-xl transition shadow-lg text-lg flex justify-center items-center gap-2">
                    CONFIRMAR Y ENVIAR <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20 pt-6">
        <div class="flex justify-between items-center mb-6 bg-white p-5 rounded-2xl shadow-md border-l-8 border-fisioPrimary">
            <h2 class="text-2xl font-bold text-fisioPrimary flex items-center gap-3"><i class="fa-solid fa-clipboard-list"></i> Control Interno</h2>
            <div class="bg-fisioLight p-2 px-4 rounded-full text-fisioPrimary border border-fisioAccent flex items-center gap-2">
                <i class="fa-solid fa-user-check"></i> <span id="staff-name-display" class="font-bold">Staff</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex p-1 bg-gray-100 rounded-xl mb-8">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-fisioAccent shadow-md">Nueva Venta</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:text-fisioOrange transition-all">Anulación</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta"> 
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                     <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Fecha Sesión</label>
                        <input type="date" id="venta-fecha" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Terapeuta</label>
                        <select id="venta-terapeuta" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option value="">Seleccionar...</option>
                            <option>Ana Pisfil</option>
                            <option>Isabel Barriga</option>
                            <option>Carmen Rodriguez</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Nombres</label>
                        <input type="text" id="venta-nombres" placeholder="Ej: Juan" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Apellidos</label>
                        <input type="text" id="venta-apellidos" placeholder="Ej: Pérez" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                     <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">DNI</label>
                        <input type="text" id="venta-dni" placeholder="N° Doc" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="col-span-2">
                         <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Servicio / Producto</label>
                         <div class="flex gap-3">
                            <select id="venta-servicio-select" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none transition" required onchange="checkCustomService(this)">
                                <option value="">Seleccionar...</option>
                                <option data-price="30">Masaje Relajante (S/30)</option>
                                <option data-price="45">Masaje Xpress Focalizado (S/45)</option>
                                <option data-price="60">Masaje Descontracturante (S/60)</option>
                                <option data-price="80">Masaje Deportivo (S/80)</option>
                                <option data-price="70">Drenaje Linfático (S/70)</option>
                                <option data-price="80">Fisioterapia Especializada (S/80)</option>
                                <option value="custom">Producto / Otro ➡️</option>
                            </select>
                            <input type="text" id="venta-detalle-custom" placeholder="Detalle..." class="hidden w-full p-3 border-2 border-fisioOrange rounded-lg bg-orange-50 font-bold focus:border-fisioOrangeHover outline-none transition fade-in">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Duración (Min)</label>
                        <select id="venta-duracion" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                            <option value="60">60 min</option>
                            <option value="80">80 min</option>
                            <option value="0">0 (Producto)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Medio de Pago</label>
                        <select id="venta-pago" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option>YAPE/PLIN</option>
                            <option>EFECTIVO</option>
                            <option>TARJETA</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Captación</label>
                        <select id="venta-captacion" class="w-full p-3 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                            <option>Redes Sociales</option>
                            <option>Flyers</option>
                            <option>Referidos</option>
                            <option>Banners</option>
                            <option>Cliente</option>
                            <option>Otros</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">Monto Total (S/)</label>
                        <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-full p-3 border-2 border-fisioAccent rounded-lg text-3xl font-extrabold text-fisioAccent text-right focus:ring-0 outline-none bg-white transition" required>
                    </div>
                </div>

                <div id="div-anulacion-motivo" class="hidden mb-8 bg-orange-50 p-6 rounded-xl border-2 border-fisioOrange fade-in">
                    <label class="block text-fisioOrange font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Motivo de la Anulación (Obligatorio)</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error de digitación..." class="w-full p-4 border-2 border-orange-200 rounded-lg focus:border-fisioOrange outline-none bg-white">
                </div>

                <button type="submit" id="btn-venta" class="w-full bg-fisioAccent hover:bg-fisioPrimary text-white font-extrabold py-4 rounded-xl text-xl shadow-md transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-save"></i> REGISTRAR OPERACIÓN
                </button>
            </form>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20 pt-6">
        <div class="flex items-center gap-4 mb-6 bg-white p-5 rounded-2xl shadow-md border-b-4 border-fisioAccent">
            <div class="bg-fisioAccent p-3 rounded-xl text-white"><i class="fa-solid fa-heart-pulse text-2xl"></i></div>
            <h2 class="text-2xl font-bold text-fisioPrimary">Historias Clínicas</h2>
        </div>
        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
            <div class="flex gap-4">
                <input type="text" id="historia-search" placeholder="Buscar por DNI o Apellido..." class="flex-grow p-4 border-2 border-gray-100 rounded-xl focus:border-fisioAccent outline-none text-lg bg-gray-50">
                <button onclick="buscarHistoria()" class="bg-fisioPrimary hover:bg-fisioHover text-white px-8 py-4 rounded-xl font-bold transition flex items-center gap-2 text-lg shadow-md">
                    <i class="fa-solid fa-search"></i>
                </button>
            </div>
            <div id="resultados-historia" class="mt-6 p-6 bg-fisioLight border border-fisioAccent rounded-xl hidden"></div>
        </div>
        <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-fisioPrimary">
            <h3 class="text-xl font-bold mb-6 text-fisioPrimary flex items-center gap-2"><i class="fa-solid fa-pen-fancy"></i> Evolución / Historia</h3>
            <form onsubmit="guardarHistoria(event)">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <input id="hc-dni" placeholder="DNI" class="p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none" required>
                    <input id="hc-nombre" placeholder="Nombre Completo" class="p-4 border-2 border-gray-100 rounded-lg col-span-2 focus:border-fisioAccent outline-none" required>
                    <input id="hc-edad" placeholder="Edad" class="p-4 border-2 border-gray-100 rounded-lg focus:border-fisioAccent outline-none">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <textarea id="hc-motivo" placeholder="Motivo Consulta" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                    <textarea id="hc-antecedentes" placeholder="Antecedentes" class="p-4 border-2 border-gray-100 rounded-lg h-32 focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                     <div class="p-6 border-2 border-gray-100 rounded-lg bg-fisioLight">
                        <label class="block font-bold mb-4 text-fisioPrimary">Nivel de Dolor (EVA 1-10)</label>
                        <div class="flex items-center gap-6">
                            <span class="text-2xl font-extrabold text-fisioAccent" id="eva-display">1</span>
                            <input type="range" min="1" max="10" value="1" class="w-full accent-fisioAccent h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('eva-display').innerText = this.value; document.getElementById('hc-eva').value = this.value">
                            <input type="hidden" id="hc-eva" value="1">
                        </div>
                     </div>
                     <textarea id="hc-tratamiento" placeholder="Tratamiento..." class="p-4 border-2 border-gray-100 rounded-lg h-full focus:border-fisioAccent outline-none resize-none"></textarea>
                </div>
                <button class="bg-fisioPrimary hover:bg-fisioHover text-white font-extrabold px-8 py-4 rounded-xl w-full shadow-lg transition text-lg">
                    GUARDAR HISTORIA
                </button>
            </form>
        </div>
    </div>

    <div id="app-gerencia" class="hidden-section container mx-auto p-4 fade-in pb-20 pt-6">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-md">
            <div>
                <h2 class="text-3xl font-extrabold text-fisioPrimary">Dashboard Gerencial</h2>
                <p class="text-sm text-gray-500">Finanzas y Gastos</p>
            </div>
            <button onclick="cargarFinanzas()" class="bg-fisioOrange text-white px-6 py-3 rounded-xl hover:bg-fisioOrangeHover transition font-bold flex items-center gap-2 shadow-md">
                <i class="fa-solid fa-rotate"></i> Actualizar Datos
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
            <div class="bg-white p-8 rounded-3xl shadow-xl border-t-4 border-green-500">
                <p class="text-green-600 font-bold uppercase mb-2"><i class="fa-solid fa-arrow-up"></i> Ingresos (Mes)</p>
                <h3 id="kpi-ingresos" class="text-4xl font-extrabold text-fisioPrimary">S/ ...</h3>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-xl border-t-4 border-fisioOrange">
                <p class="text-fisioOrange font-bold uppercase mb-2"><i class="fa-solid fa-arrow-down"></i> Gastos (Mes)</p>
                <h3 id="kpi-gastos" class="text-4xl font-extrabold text-fisioPrimary">S/ ...</h3>
            </div>
            <div class="bg-fisioPrimary p-8 rounded-3xl shadow-xl text-white">
                 <p class="text-fisioAccent font-bold uppercase mb-2">Utilidad Neta</p>
                <h3 id="kpi-utilidad" class="text-4xl font-extrabold">S/ ...</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-xl p-6 border-l-8 border-fisioOrange">
                <h3 class="font-bold text-fisioOrange mb-6 text-xl flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar"></i> Registrar Gasto</h3>
                <form onsubmit="registrarGasto(event)">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="date" id="gasto-fecha" required class="p-3 border-2 border-gray-100 rounded-lg focus:border-fisioOrange outline-none w-full">
                        <select id="gasto-categoria" class="p-3 border-2 border-gray-100 rounded-lg focus:border-fisioOrange outline-none w-full bg-white">
                            <option>Costo Variable (Insumos)</option>
                            <option>Gasto Fijo (Alquiler/Servicios)</option>
                            <option>Sueldos / Planilla</option>
                            <option>Marketing / Publicidad</option>
                            <option>Otros</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="gasto-concepto" placeholder="Detalle (Ej: Compra de Agujas)" required class="p-3 border-2 border-gray-100 rounded-lg focus:border-fisioOrange outline-none w-full">
                    </div>
                    <div class="mb-6 flex gap-4">
                         <div class="flex-grow relative">
                            <span class="absolute left-3 top-3 text-gray-400 font-bold">S/</span>
                            <input type="number" step="0.01" id="gasto-monto" placeholder="0.00" required class="p-3 pl-10 border-2 border-fisioOrange rounded-lg w-full font-extrabold text-xl text-fisioOrange focus:outline-none">
                         </div>
                         <button type="submit" class="bg-fisioOrange text-white px-8 rounded-lg font-bold hover:bg-fisioOrangeHover transition shadow-md flex items-center gap-2">Guardar <i class="fa-solid fa-check"></i></button>
                    </div>
                </form>
                
                <div class="mt-8">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase tracking-wider border-b pb-2">Últimos Gastos</h4>
                    <div class="overflow-x-auto rounded-lg border border-gray-100">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-orange-50 text-fisioOrange font-bold"><tr><th class="p-3">Fecha</th><th class="p-3">Concepto</th><th class="p-3 text-right">Monto</th><th class="p-3 text-center">X</th></tr></thead>
                            <tbody id="tabla-gastos-body" class="divide-y divide-gray-100 bg-white"><tr><td colspan="4" class="text-center p-4 italic">Cargando...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-6 border-l-8 border-fisioAccent">
                <h3 class="font-bold text-fisioPrimary mb-6 text-xl flex items-center gap-2"><i class="fa-solid fa-money-bill-wave"></i> Últimos Ingresos</h3>
                <div class="overflow-x-auto rounded-lg border border-gray-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-green-50 text-fisioPrimary font-bold"><tr><th class="p-3">Fecha</th><th class="p-3">Paciente</th><th class="p-3">Servicio</th><th class="p-3 text-right">Monto</th></tr></thead>
                        <tbody id="tabla-resumen-body" class="divide-y divide-gray-100 bg-white"><tr><td colspan="4" class="text-center p-4 italic">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-fisioPrimary bg-opacity-90 hidden flex items-center justify-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md relative">
             <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-fisioAccent"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-2xl font-extrabold text-fisioPrimary text-center mb-6">Acceso Restringido</h3>
            <input type="password" id="input-pass" class="w-full p-5 border-2 border-gray-200 rounded-xl text-center text-2xl font-bold text-fisioPrimary focus:border-fisioAccent outline-none mb-8" placeholder="••••••">
            <button onclick="verifyPass()" class="w-full py-4 bg-fisioAccent text-white font-extrabold rounded-xl hover:bg-fisioPrimary transition shadow-lg text-lg">DESBLOQUEAR</button>
        </div>
    </div>

    <script>
        // --- TU NUEVA URL DEL BACKEND (YA INTEGRADA) ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbyCjiiaqhpPRxepqwWSLMvF0zcWd1t5IjA81DkHJ2rCnDvTBVWuzr6RiE294B9z-up3cg/exec'; 

        let currentTarget = '';
        let staffUser = 'Anónimo';

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
             const hoy = new Date().toISOString().split('T')[0];
             if(document.getElementById('venta-fecha')) document.getElementById('venta-fecha').value = hoy;
             if(document.getElementById('cita-fecha')) {
                 document.getElementById('cita-fecha').value = hoy;
                 document.getElementById('cita-fecha').min = hoy; 
             }
             if(document.getElementById('gasto-fecha')) document.getElementById('gasto-fecha').value = hoy;
        });

        function validarFecha(input) { if (new Date(input.value).getUTCDay() === 0) { alert("⛔ Domingos cerrado."); input.value = ""; } }

        function checkCustomService(select) {
            const customInput = document.getElementById('venta-detalle-custom');
            const montoInput = document.getElementById('venta-monto');
            const price = select.options[select.selectedIndex].getAttribute('data-price');
            
            if (select.value === 'custom') {
                customInput.classList.remove('hidden'); customInput.required = true;
                select.classList.remove('w-full'); select.classList.add('w-1/2'); customInput.classList.add('w-1/2'); customInput.focus();
                montoInput.value = ""; 
            } else {
                customInput.classList.add('hidden'); customInput.required = false;
                select.classList.remove('w-1/2'); select.classList.add('w-full');
                if(price) montoInput.value = price;
            }
        }

        function registrarVenta(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-venta');
            const selectServicio = document.getElementById('venta-servicio-select');
            let servicioFinal = selectServicio.value === 'custom' ? document.getElementById('venta-detalle-custom').value : selectServicio.options[selectServicio.selectedIndex].text.split(' (')[0];

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true;
            
            const data = {
                action: 'registrarVenta',
                usuarioLogueado: staffUser,
                terapeuta: document.getElementById('venta-terapeuta').value,
                nombres: document.getElementById('venta-nombres').value,
                apellidos: document.getElementById('venta-apellidos').value,
                dni: document.getElementById('venta-dni').value,
                fechaSesion: document.getElementById('venta-fecha').value,
                servicio: servicioFinal,
                duracion: document.getElementById('venta-duracion').value,
                captacion: document.getElementById('venta-captacion').value,
                monto: document.getElementById('venta-monto').value,
                medioPago: document.getElementById('venta-pago').value,
                estado: document.getElementById('venta-estado').value,
                origen: document.getElementById('anulacion-motivo').value || 'Venta' 
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { 
                alert('✅ Registrado'); e.target.reset(); 
                document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; 
                checkCustomService(document.getElementById('venta-servicio-select')); 
                setStaffMode('venta'); 
            })
            .finally(() => { btn.innerHTML = '<i class="fa-solid fa-save"></i> REGISTRAR OPERACIÓN'; btn.disabled = false; });
        }

        function registrarGasto(e) {
            e.preventDefault();
            if(!confirm("¿Confirmar Gasto?")) return;
            const btn = e.target.querySelector('button'); btn.disabled = true;
            const data = {
                action: 'registrarGasto', tipo: 'Gasto',
                fechaGasto: document.getElementById('gasto-fecha').value,
                categoria: document.getElementById('gasto-categoria').value,
                concepto: document.getElementById('gasto-concepto').value,
                monto: document.getElementById('gasto-monto').value,
                usuario: 'Gerencia'
            };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { alert('✅ Gasto Guardado'); e.target.reset(); document.getElementById('gasto-fecha').value = new Date().toISOString().split('T')[0]; cargarFinanzas(); })
            .finally(() => { btn.disabled = false; });
        }

        function anularGasto(concepto, monto) {
            if(!confirm("⚠️ ¿ANULAR gasto de S/" + monto + "?")) return;
            const data = { action: 'registrarGasto', tipo: 'Anulacion', fechaGasto: new Date().toISOString().split('T')[0], categoria: 'Anulación', concepto: 'ANULACIÓN: ' + concepto, monto: monto, usuario: 'Gerencia' };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(() => { alert('✅ Anulado'); cargarFinanzas(); });
        }

        function cargarFinanzas() {
            const tbodyV = document.getElementById('tabla-resumen-body'); const tbodyG = document.getElementById('tabla-gastos-body');
            tbodyV.innerHTML = tbodyG.innerHTML = '<tr><td colspan="4" class="text-center p-4 italic"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</td></tr>';

            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'obtenerFinanzas'}) })
            .then(r => r.json())
            .then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`;
                document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`;
                document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                
                let htmlV = ''; d.listaVentas.forEach(v => {
                    htmlV += `<tr class="hover:bg-green-50 border-b"><td class="p-3">${formatDate(v[0])}</td><td class="p-3 font-bold text-fisioPrimary">${v[3]}</td><td class="p-3 text-sm">${v[7]}</td><td class="p-3 font-bold text-right text-fisioAccent">S/ ${v[9]}</td></tr>`;
                });
                tbodyV.innerHTML = htmlV || '<tr><td colspan="4" class="text-center p-4 text-gray-400">Sin datos</td></tr>';

                let htmlG = ''; d.listaGastos.forEach(g => {
                    let monto = g[4]; let btnAnular = monto > 0 ? `<button onclick="anularGasto('${g[2]}', ${monto})" class="text-fisioOrange font-bold hover:text-red-600">X</button>` : '-';
                    htmlG += `<tr class="hover:bg-orange-50 border-b"><td class="p-3">${formatDate(g[1])}</td><td class="p-3">${g[2]}</td><td class="p-3 font-bold text-right ${monto < 0 ? 'text-red-500' : 'text-fisioOrange'}">S/ ${monto}</td><td class="p-3 text-center">${btnAnular}</td></tr>`;
                });
                tbodyG.innerHTML = htmlG || '<tr><td colspan="4" class="text-center p-4 text-gray-400">Sin datos</td></tr>';
            });
        }

        function showSection(id) { document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none'); document.getElementById(id).style.display = 'block'; window.scrollTo(0,0); }
        function checkAuth(target) { currentTarget = target; document.getElementById('modal-auth').classList.remove('hidden'); document.getElementById('input-pass').value = ''; document.getElementById('input-pass').focus(); }
        function closeModal() { document.getElementById('modal-auth').classList.add('hidden'); }
        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            if (currentTarget.includes('staff')) { if (pass === 'Fisio.123') { staffUser = prompt("¿Quién eres?", "") || "Staff"; document.getElementById('staff-name-display').innerText = staffUser; closeModal(); showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia'); } else alert('⛔ Clave incorrecta');
            } else if (currentTarget === 'gerencia') { if (pass === 'marioyavril.') { closeModal(); showSection('app-gerencia'); cargarFinanzas(); } else alert('⛔ Clave incorrecta'); }
        }
        function enviarCita(e) {
            e.preventDefault(); const btn = document.getElementById('btn-cita'); const originalHtml = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...'; btn.disabled = true;
            const data = { action: 'nuevaCita', nombres: document.getElementById('cita-nombre').value, apellidos: document.getElementById('cita-apellido').value, dni: document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value, email: document.getElementById('cita-email').value, whatsapp: document.getElementById('cita-whatsapp').value, fecha: document.getElementById('cita-fecha').value, hora: document.getElementById('cita-hora').value, servicio: document.getElementById('cita-servicio').value };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(() => { alert('✅ ¡Cita Confirmada! Se envió un correo con los detalles.'); e.target.reset(); showSection('home'); }).finally(() => { btn.innerHTML = originalHtml; btn.disabled = false; });
        }
        function setStaffMode(mode) {
            const estadoInput = document.getElementById('venta-estado'); const btn = document.getElementById('btn-venta'); const motivoDiv = document.getElementById('div-anulacion-motivo'); const montoInput = document.getElementById('venta-monto');
            if (mode === 'anulacion') {
                estadoInput.value = 'Anulación'; btn.classList.replace('bg-fisioAccent', 'bg-fisioOrange'); btn.innerHTML = 'CONFIRMAR ANULACIÓN'; motivoDiv.classList.remove('hidden'); document.getElementById('anulacion-motivo').required = true;
                montoInput.classList.replace('text-fisioAccent', 'text-fisioOrange'); montoInput.classList.replace('border-fisioAccent', 'border-fisioOrange');
            } else {
                estadoInput.value = 'Venta'; btn.classList.replace('bg-fisioOrange', 'bg-fisioAccent'); btn.innerHTML = 'REGISTRAR OPERACIÓN'; motivoDiv.classList.add('hidden'); document.getElementById('anulacion-motivo').required = false;
                montoInput.classList.replace('text-fisioOrange', 'text-fisioAccent'); montoInput.classList.replace('border-fisioOrange', 'border-fisioAccent');
            }
        }
    </script>
</body>
</html>