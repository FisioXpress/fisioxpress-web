<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioXpress | Plataforma Integral</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { 'sans': ['Montserrat', 'sans-serif'] },
                extend: {
                    colors: {
                        fisioPrimary: '#2A7C78',
                        fisioPrimaryHover: '#4CA6A1', 
                        fisioAccent: '#F2911B',
                        fisioText: '#333333',
                        fisioSub: '#666666',
                        fisioBg: '#F4F8F8'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        body { background-color: #F4F8F8; color: #333333; }
        
        /* Botones Principales */
        .btn-action { 
            background-color: #F2911B; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 6px rgba(242, 145, 27, 0.2); 
        }
        .btn-action:hover { 
            background-color: #D98218; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 12px rgba(242, 145, 27, 0.3); 
        }
        
        /* Slots de Horario (Citas) */
        .time-slot { 
            border: 2px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; 
            cursor: pointer; transition: all 0.2s; background: white; 
        }
        .time-slot:hover { border-color: #2A7C78; color: #2A7C78; }
        .time-slot.selected { background-color: #2A7C78; color: white; border-color: #2A7C78; font-weight: bold; }
        
        select:disabled, input:disabled { background-color: #e2e8f0; cursor: not-allowed; color: #555; }
        
        /* Animaci√≥n para inputs din√°micos en Venta */
        .dynamic-input { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <nav class="bg-fisioPrimary text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('home')">
                <div class="relative group">
                    <img src="https://lh3.googleusercontent.com/d/1-Oryehjw29qzgFZo9mIpWB-HpldPkNQx" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063176.png'" alt="Logo FisioXpress" class="h-12 w-12 rounded-full border-2 border-white bg-white object-cover shadow-sm group-hover:scale-105 transition">
                </div>
                <span class="text-xl font-extrabold tracking-wide hidden md:block">FISIO<span class="text-fisioAccent">XPRESS</span></span>
            </div>
            
            <button onclick="showSection('home')" class="text-sm bg-white bg-opacity-10 hover:bg-white hover:text-fisioPrimary border border-white/30 text-white px-5 py-2 rounded-full transition font-bold flex items-center gap-2">
                <i class="fa-solid fa-home"></i> <span class="hidden md:inline">Inicio</span>
            </button>
        </div>
    </nav>

    <div id="home" class="container mx-auto p-6 section fade-in min-h-screen">
        <div class="text-center mb-12 mt-8">
            <h2 class="text-4xl font-extrabold text-fisioPrimary mb-3">Bienvenido a FisioXpress</h2>
            <div class="h-1 w-20 bg-fisioAccent mx-auto rounded-full mb-4"></div>
            <p class="text-lg text-fisioSub max-w-2xl mx-auto">Especialistas en recuperaci√≥n r√°pida y bienestar integral.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
            <div onclick="showSection('app-citas')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioAccent group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioAccent transition duration-300">
                    <i class="fa-solid fa-calendar-check text-3xl text-fisioAccent group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Reserva de Citas</h3>
            </div>
            
            <div onclick="checkAuth('staff')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioPrimary group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioPrimary transition duration-300">
                    <i class="fa-solid fa-cash-register text-3xl text-fisioPrimary group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Control Interno</h3>
            </div>
            
            <div onclick="checkAuth('staff_historia')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioAccent group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioAccent transition duration-300">
                    <i class="fa-solid fa-file-medical-alt text-3xl text-fisioAccent group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Historias Cl√≠nicas</h3>
            </div>
            
            <div onclick="checkAuth('gerencia')" class="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl transition cursor-pointer border-t-4 border-fisioText group hover:-translate-y-1">
                <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-fisioText transition duration-300">
                    <i class="fa-solid fa-chart-pie text-3xl text-fisioText group-hover:text-white transition"></i>
                </div>
                <h3 class="text-xl font-bold text-center mb-2 text-fisioPrimary">Gerencia</h3>
            </div>
        </div>
    </div>

    <div id="app-citas" class="hidden-section container mx-auto p-4 max-w-2xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-3 bg-fisioPrimary"></div>
            <h2 class="text-3xl font-extrabold text-fisioPrimary mb-2 text-center">Agendar Cita</h2>
            <p class="text-center text-fisioSub mb-8 text-sm">Reserva tu momento de bienestar.</p>

            <form id="form-cita" onsubmit="enviarCita(event)">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Datos Personales</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="cita-nombre" placeholder="Nombres" required class="p-4 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                        <input type="text" id="cita-apellido" placeholder="Apellidos" required class="p-4 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="cita-doc-tipo" class="p-4 bg-fisioBg rounded-lg outline-none text-fisioText font-medium">
                           <option>DNI</option><option>C.E.</option><option>PASAPORTE</option>
                        </select>
                        <input type="text" id="cita-doc-num" placeholder="Documento" required class="p-4 col-span-2 bg-fisioBg rounded-lg w-full outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                    <div class="mb-4">
                         <input type="tel" id="cita-whatsapp" placeholder="WhatsApp" required class="w-full p-4 bg-fisioBg rounded-lg outline-none focus:ring-2 focus:ring-fisioPrimary mb-4 text-fisioText">
                    </div>
                    <div class="mb-4">
                        <input type="email" id="cita-email" placeholder="Correo Electr√≥nico" required class="w-full p-4 bg-fisioBg rounded-lg outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Detalles del Servicio</label>
                    <select id="cita-servicio" onchange="configurarDuracion()" required class="w-full p-4 bg-fisioBg rounded-lg border-2 border-transparent focus:border-fisioPrimary outline-none font-bold text-fisioPrimary mb-4">
                        <option value="" disabled selected>-- Selecciona un Servicio --</option>
                        <optgroup label="Masajes Terap√©uticos">
                            <option value="Masaje Relajante" data-tipo="variable">Masaje Relajante</option>
                            <option value="Masaje Descontracturante" data-tipo="variable">Masaje Descontracturante</option>
                            <option value="Masaje Xpress" data-tipo="variable">Masaje Xpress (Zonas Dolorosas)</option>
                        </optgroup>
                        <optgroup label="Especializados">
                            <option value="Masaje Deportivo" data-tipo="fijo">Masaje Deportivo</option>
                            <option value="Drenaje Linf√°tico" data-tipo="fijo">Drenaje Linf√°tico</option>
                            <option value="Fisioterapia Especializada" data-tipo="fijo">Fisioterapia Especializada</option>
                        </optgroup>
                    </select>

                    <div id="div-duracion" class="mb-4 hidden fade-in">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 ml-1">Duraci√≥n</label>
                        <select id="cita-duracion" onchange="cargarHorarios()" required class="w-full p-4 bg-white border-2 border-fisioPrimary rounded-lg outline-none font-bold text-fisioText"></select>
                    </div>

                    <div id="div-fecha-hora" class="hidden fade-in">
                        <label class="block text-xs font-bold text-fisioPrimary uppercase tracking-wider mb-2">Fecha y Hora</label>
                        <input type="date" id="cita-fecha" onchange="cargarHorarios()" required class="p-4 bg-fisioBg rounded-lg w-full mb-4 outline-none focus:ring-2 focus:ring-fisioPrimary text-fisioText">
                        <div id="loading-slots" class="hidden text-center text-fisioAccent font-bold py-4"><i class="fa-solid fa-spinner fa-spin"></i> Buscando horarios disponibles...</div>
                        <div id="slots-container" class="grid grid-cols-3 md:grid-cols-4 gap-3"></div>
                        <input type="hidden" id="cita-hora-seleccionada" required>
                    </div>
                </div>

                <button type="submit" id="btn-cita" class="btn-action w-full text-white font-extrabold py-4 rounded-lg text-lg flex items-center justify-center gap-2">CONFIRMAR RESERVA <i class="fa-solid fa-arrow-right"></i></button>
            </form>
        </div>
    </div>

    <div id="app-staff" class="hidden-section container mx-auto p-4 max-w-4xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioPrimary">
            <h2 class="text-2xl font-bold text-fisioPrimary mb-6 flex items-center gap-2"><i class="fa-solid fa-cash-register"></i> Control Interno</h2>
            <div class="mb-4 text-sm text-fisioSub bg-fisioBg inline-block px-3 py-1 rounded-full border border-gray-200">Usuario: <span id="staff-name-display" class="font-bold text-fisioPrimary">Staff</span></div>
            
            <div class="flex p-1 bg-gray-100 rounded-lg mb-6">
                <button onclick="setStaffMode('venta')" id="tab-venta" class="flex-1 py-3 rounded-md font-bold bg-white text-fisioPrimary shadow-sm transition">Venta</button>
                <button onclick="setStaffMode('historial')" id="tab-historial" class="flex-1 py-3 rounded-md font-bold text-fisioSub hover:text-fisioPrimary transition">Historial</button>
                <button onclick="setStaffMode('anulacion')" id="tab-anulacion" class="flex-1 py-3 rounded-md font-bold text-fisioSub hover:text-red-500 transition">Anulaci√≥n</button>
            </div>
            
            <form id="form-venta" onsubmit="registrarVenta(event)">
                <input type="hidden" id="venta-estado" value="Venta">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="venta-terapeuta" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText font-bold" required>
                        <option value="">Terapeuta...</option><option>Ana Pisfil</option><option>Isabel Barriga</option><option>Carmen Rodriguez</option>
                    </select>
                    <input type="date" id="venta-fecha" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required>
                </div>

                <div class="mb-2">
                    <label class="text-xs font-bold text-fisioPrimary uppercase">B√∫squeda de Paciente</label>
                </div>
                <div class="flex gap-2 mb-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="flex-grow">
                        <label class="block text-xs text-gray-400 mb-1">Buscar por N√∫mero de Documento</label>
                        <input type="text" id="venta-search-dni" placeholder="Ingresa n√∫mero para buscar..." class="w-full p-3 bg-white rounded-lg outline-none text-fisioText font-bold border border-gray-200 focus:border-fisioPrimary">
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="buscarPacienteVenta()" class="bg-fisioPrimary hover:bg-fisioPrimaryHover text-white px-6 py-3 rounded-lg font-bold transition shadow-md h-[50px]"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-fisioPrimary uppercase mb-1">Tipo Documento</label>
                        <select id="venta-tipo-doc" class="w-full p-3 bg-fisioBg rounded-lg outline-none text-sm border-2 border-transparent focus:border-fisioPrimary" onchange="checkDocOtro(this)">
                            <option value="DNI">DNI</option>
                            <option value="CE">C.E.</option>
                            <option value="PASAPORTE">PASAPORTE</option>
                            <option value="OTRO">OTRO...</option>
                        </select>
                        <input type="text" id="venta-tipo-doc-otro" class="w-full p-2 mt-2 border rounded text-sm hidden" placeholder="Especifique Tipo">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-fisioPrimary uppercase mb-1">N√∫mero Documento</label>
                        <input type="text" id="venta-num-doc" class="w-full p-3 bg-fisioBg rounded-lg outline-none text-fisioText font-bold" placeholder="N√∫mero">
                    </div>
                    
                    <div class="md:col-span-1">
                        <input type="text" id="venta-nombres" placeholder="Nombres" class="w-full p-3 bg-white rounded border border-gray-200 text-sm font-bold" required>
                    </div>
                    <div class="md:col-span-1">
                        <input type="text" id="venta-apellidos" placeholder="Apellidos" class="w-full p-3 bg-white rounded border border-gray-200 text-sm font-bold" required>
                    </div>
                    <div class="md:col-span-1">
                        <input type="tel" id="venta-celular" placeholder="Celular" class="w-full p-3 bg-white rounded border border-gray-200 text-sm">
                    </div>
                    <div class="md:col-span-3">
                        <input type="email" id="venta-email" placeholder="Correo Electr√≥nico" class="w-full p-3 bg-white rounded border border-gray-200 text-sm">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-fisioPrimary uppercase block mb-2">Seleccionar Servicio o Producto</label>
                    <select id="venta-servicio" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText font-bold border-l-4 border-fisioAccent" required onchange="renderServiceOptions()">
                        <option value="">-- Seleccionar --</option>
                        <optgroup label="Servicios de Terapia">
                            <option value="Masaje Relajante">Masaje Relajante</option>
                            <option value="Masaje Descontracturante">Masaje Descontracturante</option>
                            <option value="Masaje Xpress">Masaje Xpress</option>
                            <option value="Masaje Deportivo">Masaje Deportivo</option>
                            <option value="Drenaje Linf√°tico">Drenaje Linf√°tico</option>
                            <option value="Fisioterapia Especializada">Fisioterapia Especializada</option>
                        </optgroup>
                        <optgroup label="Venta de Productos">
                            <option value="Producto">Producto (Venta F√≠sica)</option>
                        </optgroup>
                        <optgroup label="Planes y Paquetes">
                            <option value="Paquetes">Paquetes / Promociones</option>
                        </optgroup>
                    </select>
                </div>

                <div id="dynamic-options-container" class="mb-6 p-4 bg-white border border-gray-200 rounded-lg hidden"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Medio de Pago</label>
                        <select id="venta-pago" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" required>
                            <option>YAPE/PLIN</option><option>EFECTIVO</option><option>TARJETA</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Fuente de Captaci√≥n</label>
                        <select id="venta-fuente" class="p-3 bg-fisioBg rounded-lg w-full outline-none text-fisioText" onchange="toggleFuenteOtro()">
                            <option value="Redes Sociales">Redes Sociales</option>
                            <option value="Flyers">Flyers</option>
                            <option value="Referidos">Referidos</option>
                            <option value="Banners">Banners</option>
                            <option value="Cliente Frecuente">Cliente Frecuente</option>
                            <option value="Otro">Otro...</option>
                        </select>
                        <input type="text" id="venta-fuente-otro" placeholder="Especificar fuente..." class="mt-2 p-2 w-full border rounded hidden">
                    </div>
                </div>

                <div class="mb-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-grow w-full">
                        <input type="text" id="venta-obs" placeholder="Observaciones / Informaci√≥n Adicional" class="w-full p-4 bg-fisioBg rounded-lg outline-none text-sm">
                    </div>
                    <div class="bg-fisioBg p-4 rounded-lg border border-gray-200 flex items-center gap-3 min-w-[200px]">
                        <span class="font-bold text-fisioPrimary">TOTAL S/</span>
                        <input type="number" step="0.01" id="venta-monto" placeholder="0.00" class="w-24 p-2 text-right font-bold text-2xl text-fisioPrimary bg-white rounded border border-gray-200 outline-none" required>
                    </div>
                </div>
                
                <div id="div-anulacion-motivo" class="hidden mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                    <label class="text-red-700 font-bold block mb-2">Motivo de Anulaci√≥n:</label>
                    <input type="text" id="anulacion-motivo" placeholder="Ej: Error digitaci√≥n" class="w-full p-3 border border-red-300 rounded-lg bg-white">
                </div>
                
                <button type="submit" id="btn-venta" class="btn-action w-full text-white font-bold py-4 rounded-lg shadow-md text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-save"></i> REGISTRAR VENTA</button>
            </form>

            <div id="staff-historial-view" class="hidden mt-4">
                <div class="flex gap-2 mb-4">
                   <input id="hist-dni-staff" placeholder="Buscar historial por DNI..." class="w-full p-3 border rounded">
                   <button onclick="buscarHistorial('hist-dni-staff', 'tabla-historial-staff')" class="bg-fisioPrimary text-white px-4 rounded font-bold">VER</button>
                </div>
                <div id="tabla-historial-staff" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <div id="app-historia" class="hidden-section container mx-auto p-4 max-w-5xl fade-in pb-20 pt-10">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-t-8 border-fisioAccent">
            <h2 class="text-2xl font-bold text-fisioPrimary mb-6">Historias Cl√≠nicas</h2>
            <div class="bg-fisioBg p-6 rounded-xl mb-6 flex gap-4 items-center border border-gray-100">
                <input type="text" id="historia-search" placeholder="Buscar por DNI o Apellido" class="flex-grow p-4 bg-white rounded-lg border border-transparent focus:border-fisioAccent outline-none shadow-sm text-fisioText">
                <button onclick="buscarHistoria()" class="bg-fisioPrimary hover:bg-fisioPrimaryHover text-white px-6 py-4 rounded-lg font-bold transition shadow-md">Buscar</button>
            </div>
            <div id="resultados-historia" class="hidden mb-6 p-4 border rounded bg-gray-50 text-fisioText"></div>
            <div class="border-t border-gray-200 pt-6">
                <h3 class="font-bold mb-4 text-fisioPrimary text-lg"><i class="fa-solid fa-file-pen"></i> Nueva Evoluci√≥n</h3>
                <form onsubmit="guardarHistoria(event)">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input id="hc-dni" placeholder="DNI" class="p-3 bg-fisioBg rounded-lg outline-none text-fisioText" required>
                        <input id="hc-nombre" placeholder="Nombre Completo" class="p-3 bg-fisioBg rounded-lg col-span-2 outline-none text-fisioText" required>
                        <input id="hc-edad" placeholder="Edad" class="p-3 bg-fisioBg rounded-lg outline-none text-fisioText">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <textarea id="hc-motivo" placeholder="Motivo/Diagn√≥stico" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                        <textarea id="hc-antecedentes" placeholder="Antecedentes" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="p-4 border rounded-lg bg-white shadow-sm flex items-center gap-4">
                            <div class="bg-fisioAccent text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl" id="eva-display">1</div>
                            <div class="flex-grow">
                                <label class="block font-bold text-fisioPrimary text-sm mb-1">Escala de Dolor (EVA)</label>
                                <input type="range" min="1" max="10" value="1" class="w-full accent-fisioAccent cursor-pointer" oninput="document.getElementById('eva-display').innerText=this.value;document.getElementById('hc-eva').value=this.value">
                                <input type="hidden" id="hc-eva" value="1">
                            </div>
                        </div>
                        <textarea id="hc-tratamiento" placeholder="Tratamiento realizado hoy" class="p-3 bg-fisioBg rounded-lg h-24 outline-none resize-none text-fisioText"></textarea>
                    </div>
                    <button class="w-full bg-fisioPrimary hover:bg-fisioPrimaryHover text-white font-bold py-4 rounded-lg shadow-md transition">GUARDAR EVOLUCI√ìN</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-gerencia" class="hidden-section container mx-auto p-4 fade-in pb-20 pt-10">
        <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-2xl font-bold text-fisioPrimary">Dashboard</h2>
            <button onclick="cargarFinanzas()" class="text-fisioAccent font-bold border border-fisioAccent px-6 py-2 rounded-full hover:bg-fisioAccent hover:text-white transition flex items-center gap-2"><i class="fa-solid fa-sync"></i> Actualizar</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
                <p class="text-xs font-bold text-fisioSub uppercase tracking-widest">Ingresos</p>
                <h3 id="kpi-ingresos" class="text-4xl font-extrabold text-fisioPrimary mt-2">S/ ...</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                <p class="text-xs font-bold text-fisioSub uppercase tracking-widest">Gastos</p>
                <h3 id="kpi-gastos" class="text-4xl font-extrabold text-fisioPrimary mt-2">S/ ...</h3>
            </div>
            <div class="bg-fisioPrimary p-6 rounded-2xl shadow-lg text-white border-b-4 border-fisioAccent">
                <p class="text-xs font-bold text-white opacity-80 uppercase tracking-widest">Utilidad</p>
                <h3 id="kpi-utilidad" class="text-4xl font-extrabold mt-2 text-white">S/ ...</h3>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-fisioBg p-4 font-bold text-fisioPrimary border-b border-gray-200">√öltimas Transacciones</div>
            <table class="w-full text-left">
                <thead class="bg-white text-fisioSub text-xs uppercase border-b border-gray-100"><tr><th class="p-4">Fecha</th><th class="p-4">Paciente</th><th class="p-4 text-right">Monto</th></tr></thead>
                <tbody id="tabla-resumen-body" class="text-sm text-fisioText"><tr><td colspan="3" class="p-8 text-center text-fisioSub">Cargando datos...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 bg-fisioPrimary bg-opacity-95 hidden flex items-center justify-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center transform scale-100 transition-all">
            <div class="bg-fisioBg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-fisioPrimary"><i class="fa-solid fa-lock"></i></div>
            <h3 class="font-bold text-xl mb-4 text-fisioPrimary">Acceso Restringido</h3>
            <div class="relative w-full mb-4">
                <input type="password" id="input-pass" class="w-full p-4 pr-12 bg-fisioBg rounded-lg text-center text-lg outline-none focus:ring-2 focus:ring-fisioAccent text-fisioText" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button onclick="togglePass()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-fisioPrimary"><i class="fa-solid fa-eye" id="icon-eye"></i></button>
            </div>
            <button onclick="verifyPass()" class="btn-action w-full text-white font-bold py-3 rounded-lg shadow-md transition mb-3">ENTRAR</button>
            <button onclick="closeModal()" class="text-sm text-gray-400 hover:text-gray-600 underline">Cancelar</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw2GbvVn40mbgNPMoL8GT0xWmc8EAyQLqeKLQvt7QpBum3ZS1SsgrXLZWeQ7mcWP0P2CA/exec';

        let currentTarget = '';
        let staffUser = 'Staff';

        // --- AUTH LOGIC (EXTENDIDO) ---
        function checkAuth(target) {
            currentTarget = target;
            document.getElementById('modal-auth').classList.remove('hidden');
            const inp = document.getElementById('input-pass');
            inp.value = ''; 
            inp.type = 'password'; 
            document.getElementById('icon-eye').className = 'fa-solid fa-eye'; 
            inp.focus();
            
            // Listener para tecla Enter
            inp.onkeypress = function(e) {
                if(e.keyCode === 13) {
                    verifyPass();
                }
            };
        }

        function closeModal() {
            document.getElementById('modal-auth').classList.add('hidden');
        }
        
        function togglePass() {
            const x = document.getElementById("input-pass");
            const icon = document.getElementById("icon-eye");
            if (x.type === "password") {
                x.type = "text";
                icon.className = "fa-solid fa-eye-slash";
            } else {
                x.type = "password";
                icon.className = "fa-solid fa-eye";
            }
        }

        function verifyPass() {
            const pass = document.getElementById('input-pass').value;
            
            if ((currentTarget === 'staff' || currentTarget === 'staff_historia') && pass === 'Fisio.123') {
                staffUser = prompt("¬øQui√©n eres?", "Staff") || "Staff";
                document.getElementById('staff-name-display').innerText = staffUser;
                closeModal(); 
                showSection(currentTarget === 'staff' ? 'app-staff' : 'app-historia');
                
            } else if (currentTarget === 'gerencia' && pass === 'marioyavril.') {
                closeModal(); 
                showSection('app-gerencia'); 
                cargarFinanzas();
                
            } else {
                alert('‚õî Clave incorrecta'); 
            }
        }

        // --- NAVIGATION LOGIC ---
        function showSection(id) { 
            document.querySelectorAll('.section, .hidden-section').forEach(el => el.style.display = 'none'); 
            document.getElementById(id).style.display = 'block'; 
            window.scrollTo(0,0); 
        }

        // --- CITAS (ZONA SAGRADA - INTACTO Y EXTENDIDO) ---
        function configuringDuracion() {
            const s = document.getElementById('cita-servicio'); 
            const d = document.getElementById('cita-duracion'); 
            d.innerHTML = '';
            
            document.getElementById('div-duracion').classList.remove('hidden'); 
            document.getElementById('div-fecha-hora').classList.remove('hidden');
            
            const t = s.options[s.selectedIndex].getAttribute('data-tipo');
            
            if (t === 'variable') {
                [30, 45, 60].forEach(v => {
                    d.innerHTML += `<option value="${v}">${v} Minutos</option>`;
                });
            } else {
                d.innerHTML = '<option value="60" selected>60 Minutos</option>'; 
                if(document.getElementById('cita-fecha').value) {
                    cargarHorarios();
                }
            }
        } 
        
        window.configurarDuracion = configuringDuracion;

        function cargarHorarios() {
            const f = document.getElementById('cita-fecha').value; 
            const t = document.getElementById('cita-duracion').value;
            const container = document.getElementById('slots-container'); 
            const loading = document.getElementById('loading-slots');
            
            document.getElementById('cita-hora-seleccionada').value = "";
            
            if (!f || !t) return;
            
            let dCheck = parseInt(t); 
            if(dCheck === 45) dCheck = 60;
            
            loading.classList.remove('hidden'); 
            container.innerHTML = '';
            
            fetch(`${API_URL}?nocache=${new Date().getTime()}`, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'obtenerHorarios', fecha: f, duracionLogica: dCheck }) 
            })
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                
                if (data.error) { 
                    container.innerHTML = `<div class="text-red-500 font-bold col-span-full p-2">${data.error}</div>`; 
                    return; 
                }
                
                if (data.horarios.length === 0) { 
                    container.innerHTML = '<div class="text-red-500 font-bold col-span-full">No hay horarios.</div>'; 
                    return; 
                }
                
                data.horarios.forEach(slot => {
                    const div = document.createElement('div'); 
                    div.className = 'time-slot'; 
                    div.innerText = slot.val; 
                    
                    div.onclick = () => { 
                        document.querySelectorAll('.time-slot').forEach(d => d.classList.remove('selected')); 
                        div.classList.add('selected'); 
                        document.getElementById('cita-hora-seleccionada').value = slot.val; 
                    };
                    
                    container.appendChild(div);
                });
            })
            .catch(() => { 
                loading.classList.add('hidden'); 
                alert('Error conexi√≥n'); 
            });
        }

        function enviarCita(e) {
            e.preventDefault(); 
            const h = document.getElementById('cita-hora-seleccionada').value; 
            if (!h) return alert("‚ö†Ô∏è Selecciona un horario.");
            
            const btn = document.getElementById('btn-cita'); 
            const html = btn.innerHTML; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Agendando...'; 
            btn.disabled = true;
            
            const dniFull = document.getElementById('cita-doc-tipo').value + ' ' + document.getElementById('cita-doc-num').value;
            
            const data = { 
                action: 'nuevaCita', 
                nombres: document.getElementById('cita-nombre').value, 
                apellidos: document.getElementById('cita-apellido').value, 
                dni: dniFull, 
                email: document.getElementById('cita-email').value, 
                whatsapp: document.getElementById('cita-whatsapp').value, 
                fecha: document.getElementById('cita-fecha').value, 
                hora: h, 
                duracionReal: document.getElementById('cita-duracion').value, 
                servicio: document.getElementById('cita-servicio').value 
            };
            
            fetch(`${API_URL}?nocache=${new Date().getTime()}`, { method: 'POST', body: JSON.stringify(data) })
            .then(r => r.json())
            .then(result => {
                if (result.status === 'success') { 
                    alert(`‚úÖ ¬°Cita Confirmada para ${result.nombre}!\n\nüìÖ Fecha: ${result.fecha}\n‚è∞ Hora: ${data.hora}\n\nüìß IMPORTANTE: Hemos enviado los detalles a tu correo.`); 
                    e.target.reset(); 
                    document.getElementById('slots-container').innerHTML = ''; 
                    showSection('home'); 
                } else { 
                    alert(`‚ö†Ô∏è ${result.message}`); 
                    cargarHorarios(); 
                }
            })
            .finally(() => { 
                btn.innerHTML = html; 
                btn.disabled = false; 
            });
        }

        // --- STAFF LOGIC (ACTUALIZADO Y EXTENDIDO) ---
        function setStaffMode(mode) {
            const isAnulacion = mode === 'anulacion'; 
            const isHistorial = mode === 'historial';
            const formVenta = document.getElementById('form-venta'); 
            const viewHist = document.getElementById('staff-historial-view');
            
            ['venta','historial','anulacion'].forEach(t => {
                document.getElementById(`tab-${t}`).className = 'flex-1 py-3 rounded-md font-bold text-fisioSub transition';
            });
            document.getElementById(`tab-${mode}`).className = 'flex-1 py-3 rounded-md font-bold bg-white text-fisioPrimary shadow-sm transition';

            if(isHistorial) {
                formVenta.classList.add('hidden'); 
                viewHist.classList.remove('hidden');
            } else {
                formVenta.classList.remove('hidden'); 
                viewHist.classList.add('hidden');
                
                document.getElementById('venta-estado').value = isAnulacion ? 'Anulaci√≥n' : 'Venta';
                document.getElementById('div-anulacion-motivo').classList.toggle('hidden', !isAnulacion);
                document.getElementById('anulacion-motivo').required = isAnulacion;
                
                const btn = document.getElementById('btn-venta');
                if(isAnulacion) { 
                    btn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow text-lg transition'; 
                    btn.innerText = 'CONFIRMAR ANULACI√ìN'; 
                } else { 
                    btn.className = 'btn-action w-full text-white font-bold py-4 rounded-lg shadow-md text-lg transition'; 
                    btn.innerText = 'REGISTRAR VENTA'; 
                }
            }
        }

        // Nueva l√≥gica de b√∫squeda y llenado manual
        function checkDocOtro(sel) {
            const inp = document.getElementById('venta-tipo-doc-otro');
            if(sel.value === 'OTRO') {
                inp.classList.remove('hidden'); 
            } else {
                inp.classList.add('hidden');
            }
        }

        function buscarPacienteVenta() {
            const dniBusqueda = document.getElementById('venta-search-dni').value;
            if(!dniBusqueda) return alert("Ingresa un n√∫mero para buscar.");
            
            const btn = document.querySelector('button[onclick="buscarPacienteVenta()"]');
            const originalIcon = btn.innerHTML; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; 
            btn.disabled = true;

            fetch(`${API_URL}?nocache=${Date.now()}`, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'buscarPaciente', dni: dniBusqueda }) 
            })
            .then(r => r.json())
            .then(d => {
                if(d.found){ 
                    // Si encuentra, llena todo y asume DNI o deja que el usuario ajuste
                    document.getElementById('venta-nombres').value = d.nombres || d.nombreCompleto || '';
                    document.getElementById('venta-apellidos').value = d.apellidos || '';
                    document.getElementById('venta-celular').value = d.celular || '';
                    document.getElementById('venta-email').value = d.email || '';
                    
                    // Asignar el n√∫mero encontrado al campo de registro
                    document.getElementById('venta-num-doc').value = dniBusqueda;
                    
                    // Intentar deducir tipo de documento
                    if(dniBusqueda.length === 8) {
                        document.getElementById('venta-tipo-doc').value = 'DNI';
                    } else if(dniBusqueda.length > 8) {
                        document.getElementById('venta-tipo-doc').value = 'CE';
                    }
                    
                    alert("‚úÖ Paciente encontrado");
                } else {
                    alert("‚ö†Ô∏è Paciente no registrado. Habilitando registro manual...");
                    document.getElementById('venta-num-doc').value = dniBusqueda;
                    document.getElementById('venta-nombres').value = '';
                    document.getElementById('venta-apellidos').value = '';
                    document.getElementById('venta-nombres').focus();
                }
            })
            .finally(() => { 
                btn.innerHTML = originalIcon; 
                btn.disabled = false; 
            });
        }

        function renderServiceOptions() {
            const tipo = document.getElementById('venta-servicio').value;
            const container = document.getElementById('dynamic-options-container');
            container.innerHTML = ''; 
            container.classList.add('hidden');
            
            if (!tipo) return;
            
            container.classList.remove('hidden');
            
            if (tipo === 'Producto') {
                container.innerHTML = `
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cantidad de Productos</label>
                    <input type="number" min="1" max="10" id="prod-cantidad" class="w-full p-2 border rounded mb-3" placeholder="Ej: 1" onchange="createProductInputs(this.value)">
                    <div id="prod-inputs-list" class="space-y-2"></div>`;
            } else if (tipo === 'Paquetes') {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre Paquete</label>
                            <input type="text" id="paq-nombre" class="w-full p-2 border rounded" placeholder="Ej: Pack Dolor">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Num. Sesiones</label>
                            <input type="number" id="paq-sesiones" class="w-full p-2 border rounded" placeholder="Ej: 5">
                        </div>
                    </div>`;
            } else {
                container.innerHTML = `
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tiempo de Sesi√≥n</label>
                    <select id="serv-tiempo" class="w-full p-2 border rounded bg-white" onchange="checkOtroTiempo(this)">
                        <option value="30">30 Minutos</option>
                        <option value="45">45 Minutos</option>
                        <option value="60">60 Minutos</option>
                        <option value="Otro">Otro...</option>
                    </select>
                    <input type="number" id="serv-tiempo-otro" class="w-full p-2 border rounded mt-2 hidden dynamic-input" placeholder="Ingresa minutos (Ej: 90)">`;
            }
        }

        function checkOtroTiempo(sel) { 
            const inp = document.getElementById('serv-tiempo-otro'); 
            if(sel.value === 'Otro') {
                inp.classList.remove('hidden'); 
            } else {
                inp.classList.add('hidden');
            }
        }

        function createProductInputs(qty) { 
            const list = document.getElementById('prod-inputs-list'); 
            list.innerHTML = ''; 
            const n = parseInt(qty); 
            if(n > 0) { 
                for(let i=1; i<=n; i++) { 
                    list.innerHTML += `<input type="text" class="w-full p-2 border rounded dynamic-input" placeholder="Nombre del Producto ${i}" name="prod-detalle">`; 
                } 
            } 
        }

        function toggleFuenteOtro() { 
            const sel = document.getElementById('venta-fuente'); 
            const inp = document.getElementById('venta-fuente-otro'); 
            if(sel.value === 'Otro') {
                inp.classList.remove('hidden'); 
            } else {
                inp.classList.add('hidden');
            }
        }

        function registrarVenta(e) {
            e.preventDefault(); 
            const btn = document.getElementById('btn-venta'); 
            const txt = btn.innerText; 
            btn.innerText = 'Guardando...'; 
            btn.disabled = true;

            let tiempoServicio = '';
            let detalleProductos = '';
            let detallePaquete = '';
            
            const tipoServicio = document.getElementById('venta-servicio').value;
            
            if(tipoServicio === 'Producto') { 
                const inputs = document.getElementsByName('prod-detalle'); 
                let prods = []; 
                inputs.forEach(i => { if(i.value) prods.push(i.value) }); 
                detalleProductos = prods.join(', '); 
            } else if (tipoServicio === 'Paquetes') { 
                const nom = document.getElementById('paq-nombre').value; 
                const ses = document.getElementById('paq-sesiones').value; 
                detallePaquete = `${nom} (${ses} sesiones)`; 
            } else { 
                const selT = document.getElementById('serv-tiempo'); 
                if(selT) { 
                    tiempoServicio = selT.value === 'Otro' ? document.getElementById('serv-tiempo-otro').value : selT.value; 
                } 
            }

            const fuenteSel = document.getElementById('venta-fuente').value;
            const fuenteFinal = fuenteSel === 'Otro' ? document.getElementById('venta-fuente-otro').value : fuenteSel;

            // Construir DNI Completo
            const tipoDoc = document.getElementById('venta-tipo-doc').value;
            const tipoDocFinal = tipoDoc === 'OTRO' ? document.getElementById('venta-tipo-doc-otro').value : tipoDoc;
            const numDoc = document.getElementById('venta-num-doc').value;
            const dniFull = `${tipoDocFinal} ${numDoc}`;

            const data = { 
                action: 'registrarVenta', 
                usuarioLogueado: staffUser, 
                terapeuta: document.getElementById('venta-terapeuta').value, 
                
                nombres: document.getElementById('venta-nombres').value, 
                apellidos: document.getElementById('venta-apellidos').value,
                
                fechaSesion: document.getElementById('venta-fecha').value, 
                servicio: tipoServicio, 
                monto: document.getElementById('venta-monto').value, 
                medioPago: document.getElementById('venta-pago').value, 
                estado: document.getElementById('venta-estado').value, 
                origen: document.getElementById('anulacion-motivo').value || 'Venta', 
                dni: dniFull, 
                email: document.getElementById('venta-email').value, 
                celular: document.getElementById('venta-celular').value,
                
                fuente: fuenteFinal, 
                observaciones: document.getElementById('venta-obs').value,
                tiempoServicio: tiempoServicio, 
                detalleProductos: detalleProductos, 
                detallePaquete: detallePaquete
            };

            fetch(`${API_URL}?nocache=${Date.now()}`, { method: 'POST', body: JSON.stringify(data) })
            .then(() => { 
                alert('‚úÖ Operaci√≥n registrada correctamente'); 
                e.target.reset(); 
                document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0]; 
                renderServiceOptions(); 
                setStaffMode('venta'); 
            })
            .finally(() => { 
                btn.innerText = txt; 
                btn.disabled = false; 
            });
        }

        // --- GERENCIA & HISTORIA (INTACTO) ---
        function cargarFinanzas() {
            const tbody = document.getElementById('tabla-resumen-body'); 
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Cargando...</td></tr>';
            
            fetch(`${API_URL}?nocache=${Date.now()}`, { 
                method: 'POST', body: JSON.stringify({action: 'obtenerFinanzas'}) 
            })
            .then(r => r.json())
            .then(d => {
                document.getElementById('kpi-ingresos').innerText = `S/ ${d.ingresos}`; 
                document.getElementById('kpi-gastos').innerText = `S/ ${d.egresos}`; 
                document.getElementById('kpi-utilidad').innerText = `S/ ${d.utilidad}`;
                
                tbody.innerHTML = ''; 
                d.listaVentas.forEach(v => { 
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-4">${new Date(v[1]).toLocaleDateString()}</td>
                            <td class="p-4 font-bold">${v[4]}</td>
                            <td class="p-4 font-bold text-right">S/ ${v[6]}</td>
                        </tr>`; 
                });
            });
        }

        function buscarHistorial(inputId, divId) {
             const t = document.getElementById(inputId || 'historia-search').value; 
             const div = document.getElementById(divId || 'resultados-historia');
             
             fetch(`${API_URL}?nocache=${Date.now()}`, { 
                 method: 'POST', body: JSON.stringify({ action: 'buscarHistorialVentas', termino: t }) 
             })
             .then(r => r.json())
             .then(d => {
                let h = '<table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2">Fecha</th><th class="p-2">Servicio</th><th class="p-2">S/</th></tr></thead><tbody>';
                d.forEach(v => {
                    h += `<tr><td class="p-2 border-b">${v.fecha}</td><td class="p-2 border-b">${v.servicio}</td><td class="p-2 border-b font-bold">${v.monto}</td></tr>`;
                });
                div.innerHTML = d.length ? h+'</tbody></table>' : 'Sin datos'; 
                div.classList.remove('hidden');
            });
        }

        function buscarHistoria() { 
            buscarHistorial('historia-search', 'resultados-historia'); 
        }

        function guardarHistoria(e) { 
            e.preventDefault(); 
            alert('‚úÖ Evoluci√≥n guardada (Simulaci√≥n Frontend).'); 
            e.target.reset(); 
        }
        
        // --- INICIALIZACI√ìN (INTACTO) ---
        document.addEventListener('DOMContentLoaded', () => { 
            if(document.getElementById('venta-fecha')) {
                document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0];
            }
        });

    </script>
</body>
</html>